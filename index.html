<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EverCoco - Personal Organizer</title>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #74acf2;
      --secondary-color: #0058a3;
      --accent-color: #0058a3;
      --text-color: #000;
      --background-color: #fff;
      --font-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      margin: 0;
      font-family: var(--font-primary);
      background-color: var(--background-color);
      color: var(--text-color);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--primary-color);
      color: var(--accent-color);
      padding: 15px 30px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .logo {
      display: flex;
      align-items: center;
      cursor: default;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .logo i {
      margin-right: 10px;
    }
    nav.header-nav {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .nav-item {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 1rem;
      color: var(--background-color);
      transition: color 0.3s;
    }
    .nav-item i {
      margin-right: 8px;
      font-size: 1.1rem;
    }
    .nav-item:hover {
      color: var(--accent-color);
    }
    .nav-item.active {
      border-bottom: 2px solid var(--accent-color);
    }
    .header-right {
      position: relative;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-right i {
      cursor: pointer;
      font-size: 1.2rem;
      transition: color 0.3s;
      position: relative;
    }
    .header-right i:hover {
      color: var(--secondary-color);
    }
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -10px;
      background-color: #f44336;
      color: #fff;
      padding: 2px 6px;
      border-radius: 50%;
      font-size: 0.75rem;
      display: none;
    }
    main {
      padding: 80px 40px 40px 40px;
      transition: padding 0.3s ease;
    }
    .kanban-board {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    .kanban-column {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      flex: 1;
      min-width: 300px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
      overflow-y: auto;
    }
    .kanban-column h3 {
      margin-top: 0;
      display: flex;
      align-items: center;
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    .kanban-column h3 i {
      margin-right: 10px;
    }
    .cards-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .card {
      background-color: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    .card:hover {
      background-color: #f0f0f0;
      transform: translateY(-2px);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-header-left i {
      font-size: 1rem;
      color: var(--primary-color);
    }
    .card-header .title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
    }
    .card-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-header .favorite-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #ff9800;
      font-size: 1rem;
      transition: color 0.3s;
    }
    .card-header .favorite-btn:hover {
      color: #e68900;
    }
    .card-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: #555;
      font-size: 0.9rem;
      transition: color 0.3s;
    }
    .card-actions button:hover {
      color: var(--primary-color);
    }
    .details {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #555;
    }
    .attachments img {
      max-width: 100px;
      max-height: 100px;
      margin-right: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .attachments a {
      display: inline-block;
      margin-top: 8px;
      color: var(--primary-color);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .attachments a:hover {
      text-decoration: underline;
    }
    .scratchpad-section {
      margin-bottom: 30px;
    }
    .scratchpad-section h4 {
      display: flex;
      align-items: center;
      font-size: 1.1rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    .scratchpad-section h4 i {
      margin-right: 8px;
    }
    #scratchpad {
      width: 100%;
      height: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      font-size: 0.95rem;
      background-color: #fff;
      color: var(--text-color);
      box-sizing: border-box;
    }
    .scratchpad-section button {
      margin-top: 10px;
      align-self: flex-end;
    }
    input[type="text"],
    textarea,
    select,
    input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.95rem;
      background-color: #fff;
      color: var(--text-color);
    }
    textarea {
      resize: vertical;
      min-height: 200px;
      height: auto;
      overflow: auto;
    }
    label {
      font-weight: 500;
      color: var(--text-color);
    }
    .multi-select {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
    }
    .multi-select label {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .multi-select label:hover {
      background-color: #e0e0e0;
      border-color: #bbb;
    }
    .multi-select label input {
      margin-right: 6px;
      cursor: pointer;
    }
    #note-new-tags,
    #edit-note-new-tags {
      width: 100%;
      padding: 8px 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      color: var(--text-color);
      font-size: 0.95rem;
    }
    .recurrence-options label {
      display: inline-block;
      margin-right: 15px;
      font-weight: normal;
      color: #555;
    }
    .custom-days {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
    }
    .custom-days label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: normal;
      color: #555;
    }
    .btn {
      background-color: var(--secondary-color);
      color: var(--background-color);
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.3s;
      align-self: flex-start;
    }
    .btn:hover {
      background-color: #004a80;
    }
    .notification {
      position: fixed;
      top: 80px;
      right: 30px;
      background-color: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .notification.show {
      opacity: 1;
    }
    .notification.success {
      background-color: #4CAF50;
    }
    .notification.error {
      background-color: #f44336;
    }
    footer {
      text-align: center;
      padding: 15px;
      font-size: 0.85rem;
      color: #777;
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #f9f9f9;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
    }
    @media (max-width: 1200px) {
      .kanban-board {
        justify-content: center;
      }
    }
    @media (max-width: 768px) {
      main {
        padding: 80px 20px 60px 20px;
      }
      header {
        padding: 15px 20px;
        flex-direction: column;
        align-items: flex-start;
      }
      nav.header-nav {
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .header-right {
        margin-top: 10px;
        gap: 10px;
      }
    }
    .search-modal {
      display: none;
      position: fixed;
      z-index: 1500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }
    .search-modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #ccc;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close {
      color: #555;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: var(--primary-color);
      text-decoration: none;
    }
    #search-input {
      width: 100%;
      padding: 12px 20px;
      margin: 12px 0 20px 0;
      box-sizing: border-box;
      border: 2px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      background-color: #fff;
      color: var(--text-color);
    }
    #search-results {
      max-height: 400px;
      overflow-y: auto;
      color: var(--text-color);
    }
    .search-category {
      margin-bottom: 20px;
    }
    .search-category h4 {
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    .search-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-item:hover {
      background-color: #f0f0f0;
    }
    .highlight {
      background-color: #ffd700;
      color: #000;
    }
    .notifications-modal {
      display: none;
      position: fixed;
      z-index: 1600;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }
    .notifications-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #ccc;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .notifications-modal-content h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    .notification-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      color: var(--text-color);
      background-color: #f9f9f9;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .notification-item p {
      margin: 0;
      font-size: 0.95rem;
    }
    .notification-item small {
      color: #777;
    }
    .notification-item button {
      margin-top: 5px;
      background-color: var(--secondary-color);
      color: var(--background-color);
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.3s;
    }
    .notification-item button:hover {
      background-color: #004a80;
    }
    .edit-modal {
      display: none;
      position: fixed;
      z-index: 1700;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }
    .edit-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #ccc;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .edit-modal-content h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    .edit-modal-content form {
      display: flex;
      flex-direction: column;
    }
    .edit-modal-content .form-group {
      margin-top: 10px;
    }
    .edit-modal-content .recurrence-options label {
      display: inline-block;
      margin-right: 15px;
      font-weight: normal;
      color: #555;
    }
    .edit-modal-content .custom-days {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
    }
    .edit-modal-content .custom-days label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: normal;
      color: #555;
    }
    .edit-modal-content .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .edit-modal-content .btn-group .btn {
      flex: 1;
    }
    .nested-notes {
      display: grid;
      grid-template-columns: repeat(auto-fill, 120px);
      grid-gap: 20px;
      padding-left: 20px;
      border-left: 2px solid #ddd;
      margin-top: 10px;
      overflow-x: hidden;
    }
    .nested-note-card {
      width: 120px;
      height: 160px;
      background-color: #fff;
      border-radius: 4px;
      padding: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      padding: 5px;
      overflow: hidden;
    }
    .nested-note-card:hover {
      background-color: #f0f0f0;
      transform: translateY(-2px);
    }
    .nested-note-title {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nested-note-snippet {
      font-size: 0.75rem;
      color: #555;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .expand-icon {
      margin-left: auto;
      transition: transform 0.3s;
    }
    .expand-icon.expanded {
      transform: rotate(90deg);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-feather-alt"></i>
      <span>EverCoco</span>
    </div>
    <nav class="header-nav">
      <div class="nav-item active" onclick="navigate('dashboard')">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="navigate('notebooks')">
        <i class="fas fa-book"></i>
        <span>Notebooks</span>
      </div>
      <div class="nav-item" onclick="navigate('tags')">
        <i class="fas fa-tags"></i>
        <span>Tags</span>
      </div>
      <div class="nav-item" onclick="navigate('notes')">
        <i class="fas fa-sticky-note"></i>
        <span>Notes</span>
      </div>
      <div class="nav-item" onclick="navigate('tasks')">
        <i class="fas fa-tasks"></i>
        <span>Tasks</span>
      </div>
      <div class="nav-item" onclick="navigate('habits')">
        <i class="fas fa-heartbeat"></i>
        <span>Habits</span>
      </div>
      <div class="nav-item" onclick="navigate('trash')">
        <i class="fas fa-trash"></i>
        <span>Trash</span>
      </div>
    </nav>
    <div class="header-right">
      <i class="fas fa-search" title="Search" onclick="openSearch()"></i>
      <i class="fas fa-bell" title="Notifications" onclick="openNotifications()">
        <span class="notification-badge" id="notification-badge">0</span>
      </i>
      <i class="fas fa-user-circle" title="Profile" onclick="showProfile()"></i>
    </div>
  </header>
  <main>
    <div class="kanban-board">
      <section class="kanban-column" id="dashboard-section">
        <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
        <p>Welcome to EverCoco! Manage your notes, tasks, and habits efficiently.</p>
        <div class="scratchpad-section">
          <h4><i class="fas fa-pencil-alt"></i> Scratchpad</h4>
          <textarea id="scratchpad" placeholder="Quick notes..."></textarea>
          <button class="btn" onclick="saveScratchpad()">Save</button>
        </div>
        <div class="favorites-section">
          <h4><i class="fas fa-star"></i> Favorites</h4>
          <div class="favorites-subsection" id="favorite-notebooks">
            <h5><i class="fas fa-book"></i> Notebooks</h5>
            <div class="favorites-list" id="favorites-dashboard-notebooks-list"></div>
          </div>
          <div class="favorites-subsection" id="favorite-tags">
            <h5><i class="fas fa-tags"></i> Tags</h5>
            <div class="favorites-list" id="favorites-dashboard-tags-list"></div>
          </div>
          <div class="favorites-subsection" id="favorite-notes">
            <h5><i class="fas fa-sticky-note"></i> Notes</h5>
            <div class="favorites-list" id="favorites-dashboard-notes-list"></div>
          </div>
          <div class="favorites-subsection" id="favorite-tasks">
            <h5><i class="fas fa-tasks"></i> Tasks</h5>
            <div class="favorites-list" id="favorites-dashboard-tasks-list"></div>
          </div>
          <div class="favorites-subsection" id="favorite-habits">
            <h5><i class="fas fa-heartbeat"></i> Habits</h5>
            <div class="favorites-list" id="favorites-dashboard-habits-list"></div>
          </div>
        </div>
      </section>
      <section class="kanban-column" id="notebooks-section" style="display: none;">
        <h3><i class="fas fa-book"></i> Notebooks</h3>
        <p>Create and organize your notebooks.</p>
        <input type="text" id="new-notebook-input" placeholder="Enter notebook name..." />
        <button class="btn" onclick="addNotebook()">Add Notebook</button>
        <div class="cards-list" id="notebooks-list"></div>
      </section>
      <section class="kanban-column" id="tags-section" style="display: none;">
        <h3><i class="fas fa-tags"></i> Tags</h3>
        <p>Create and manage tags for better organization.</p>
        <input type="text" id="new-tag-input" placeholder="Enter tag name..." />
        <button class="btn" onclick="addTag()">Add Tag</button>
        <div class="cards-list" id="tags-list"></div>
      </section>
      <section class="kanban-column" id="notes-section" style="display: none;">
        <h3><i class="fas fa-sticky-note"></i> Notes</h3>
        <p>Create and manage your notes.</p>
        <input type="text" id="note-title" placeholder="Note Title..." />
        <textarea id="note-body" rows="3" placeholder="Note Body..."></textarea>
        <label><strong>Tags:</strong></label>
        <div id="note-tags" class="multi-select"></div>
        <input type="text" id="note-new-tags" placeholder="Add new tags (comma separated)" />
        <label><strong>Notebook:</strong></label>
        <select id="note-notebook-select">
          <option value="">No Notebook</option>
        </select>
        <label><strong>Attachments:</strong></label>
        <input type="file" id="note-attachments" multiple accept="image/*,application/pdf,.doc,.docx,.txt" />
        <small>Max size: 2MB. Supported: Images, PDF, DOC, DOCX, TXT.</small>
        <button class="btn" onclick="addNote()">Add Note</button>
        <div class="cards-list" id="notes-list"></div>
      </section>
      <section class="kanban-column" id="tasks-section" style="display: none;">
        <h3><i class="fas fa-tasks"></i> Tasks</h3>
        <p>Create and manage your tasks with due dates and recurrence.</p>
        <input type="text" id="task-input" placeholder="Enter task description..." />
        <input type="date" id="task-due-date" />
        <label><strong>Recurrence:</strong></label>
        <div class="recurrence-options">
          <label><input type="radio" name="task-recurrence" value="none" checked onclick="toggleTaskCustomDays(false)"> None</label>
          <label><input type="radio" name="task-recurrence" value="daily" onclick="toggleTaskCustomDays(false)"> Daily</label>
          <label><input type="radio" name="task-recurrence" value="weekly" onclick="toggleTaskCustomDays(false)"> Weekly</label>
          <label><input type="radio" name="task-recurrence" value="monthly" onclick="toggleTaskCustomDays(false)"> Monthly</label>
          <label><input type="radio" name="task-recurrence" value="custom" onclick="toggleTaskCustomDays(true)"> Custom Days</label>
        </div>
        <div id="task-custom-days" class="custom-days" style="display: none;">
          <label><input type="checkbox" value="Monday"> M</label>
          <label><input type="checkbox" value="Tuesday"> T</label>
          <label><input type="checkbox" value="Wednesday"> W</label>
          <label><input type="checkbox" value="Thursday"> T</label>
          <label><input type="checkbox" value="Friday"> F</label>
          <label><input type="checkbox" value="Saturday"> S</label>
          <label><input type="checkbox" value="Sunday"> S</label>
        </div>
        <button class="btn" onclick="addTask()">Add Task</button>
        <div class="cards-list" id="tasks-list"></div>
      </section>
      <section class="kanban-column" id="habits-section" style="display: none;">
        <h3><i class="fas fa-heartbeat"></i> Habits</h3>
        <p>Create and track your habits.</p>
        <input type="text" id="habit-input" placeholder="Enter habit description..." />
        <label><strong>Recurrence:</strong></label>
        <div class="recurrence-options">
          <label><input type="radio" name="habit-recurrence" value="none" checked onclick="toggleHabitCustomDays(false)"> None</label>
          <label><input type="radio" name="habit-recurrence" value="daily" onclick="toggleHabitCustomDays(false)"> Daily</label>
          <label><input type="radio" name="habit-recurrence" value="weekly" onclick="toggleHabitCustomDays(false)"> Weekly</label>
          <label><input type="radio" name="habit-recurrence" value="monthly" onclick="toggleHabitCustomDays(false)"> Monthly</label>
          <label><input type="radio" name="habit-recurrence" value="custom" onclick="toggleHabitCustomDays(true)"> Custom Days</label>
        </div>
        <div id="habit-custom-days" class="custom-days" style="display: none;">
          <label><input type="checkbox" value="Monday"> M</label>
          <label><input type="checkbox" value="Tuesday"> T</label>
          <label><input type="checkbox" value="Wednesday"> W</label>
          <label><input type="checkbox" value="Thursday"> T</label>
          <label><input type="checkbox" value="Friday"> F</label>
          <label><input type="checkbox" value="Saturday"> S</label>
          <label><input type="checkbox" value="Sunday"> S</label>
        </div>
        <button class="btn" onclick="addHabit()">Add Habit</button>
        <div class="cards-list" id="habits-list"></div>
      </section>
      <section class="kanban-column" id="trash-section" style="display: none;">
        <h3><i class="fas fa-trash"></i> Trash</h3>
        <p>Manage your deleted notes here.</p>
        <div class="cards-list" id="trash-list"></div>
      </section>
    </div>
  </main>
  <div id="search-modal" class="search-modal">
    <div class="search-modal-content">
      <span class="close" onclick="closeSearch()">&times;</span>
      <h2>Search EverCoco</h2>
      <input type="text" id="search-input" placeholder="Type to search..." oninput="performSearch()" />
      <div id="search-results"></div>
    </div>
  </div>
  <div id="notifications-modal" class="notifications-modal">
    <div class="notifications-modal-content">
      <span class="close" onclick="closeNotifications()">&times;</span>
      <h2>Notifications</h2>
      <div id="notifications-list"></div>
    </div>
  </div>
  <div id="edit-notebook-modal" class="edit-modal">
    <div class="edit-modal-content">
      <span class="close" onclick="closeEditModal('notebook')">&times;</span>
      <h2>Edit Notebook</h2>
      <form id="edit-notebook-form">
        <div class="form-group">
          <label for="edit-notebook-name">Name:</label>
          <input type="text" id="edit-notebook-name" required />
        </div>
        <div class="btn-group">
          <button type="submit" class="btn">Save</button>
          <button type="button" class="btn" onclick="closeEditModal('notebook')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <div id="edit-tag-modal" class="edit-modal">
    <div class="edit-modal-content">
      <span class="close" onclick="closeEditModal('tag')">&times;</span>
      <h2>Edit Tag</h2>
      <form id="edit-tag-form">
        <div class="form-group">
          <label for="edit-tag-name">Name:</label>
          <input type="text" id="edit-tag-name" required />
        </div>
        <div class="btn-group">
          <button type="submit" class="btn">Save</button>
          <button type="button" class="btn" onclick="closeEditModal('tag')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <div id="edit-note-modal" class="edit-modal">
    <div class="edit-modal-content">
      <span class="close" onclick="closeEditModal('note')">&times;</span>
      <h2>Edit Note</h2>
      <form id="edit-note-form">
        <div class="form-group">
          <label for="edit-note-title">Title:</label>
          <input type="text" id="edit-note-title" required />
        </div>
        <div class="form-group">
          <label for="edit-note-body">Body:</label>
          <textarea id="edit-note-body" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label><strong>Tags:</strong></label>
          <div id="edit-note-tags" class="multi-select"></div>
          <input type="text" id="edit-note-new-tags" placeholder="Add new tags (comma separated)" />
        </div>
        <div class="form-group">
          <label for="edit-note-notebook">Notebook:</label>
          <select id="edit-note-notebook">
            <option value="">No Notebook</option>
          </select>
        </div>
        <div class="form-group">
          <label><strong>Attachments:</strong></label>
          <input type="file" id="edit-note-attachments" multiple accept="image/*,application/pdf,.doc,.docx,.txt" />
          <small>Max size: 2MB. Supported: Images, PDF, DOC, DOCX, TXT.</small>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn">Save</button>
          <button type="button" class="btn" onclick="closeEditModal('note')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <div id="edit-task-modal" class="edit-modal">
    <div class="edit-modal-content">
      <span class="close" onclick="closeEditModal('task')">&times;</span>
      <h2>Edit Task</h2>
      <form id="edit-task-form">
        <div class="form-group">
          <label for="edit-task-description">Description:</label>
          <input type="text" id="edit-task-description" required />
        </div>
        <div class="form-group">
          <label for="edit-task-due-date">Due Date:</label>
          <input type="date" id="edit-task-due-date" />
        </div>
        <div class="form-group">
          <label><strong>Recurrence:</strong></label>
          <div class="recurrence-options">
            <label><input type="radio" name="edit-task-recurrence" value="none" checked onclick="toggleEditTaskCustomDays(false)"> None</label>
            <label><input type="radio" name="edit-task-recurrence" value="daily" onclick="toggleEditTaskCustomDays(false)"> Daily</label>
            <label><input type="radio" name="edit-task-recurrence" value="weekly" onclick="toggleEditTaskCustomDays(false)"> Weekly</label>
            <label><input type="radio" name="edit-task-recurrence" value="monthly" onclick="toggleEditTaskCustomDays(false)"> Monthly</label>
            <label><input type="radio" name="edit-task-recurrence" value="custom" onclick="toggleEditTaskCustomDays(true)"> Custom Days</label>
          </div>
        </div>
        <div id="edit-task-custom-days" class="custom-days" style="display: none;">
          <label><input type="checkbox" value="Monday"> M</label>
          <label><input type="checkbox" value="Tuesday"> T</label>
          <label><input type="checkbox" value="Wednesday"> W</label>
          <label><input type="checkbox" value="Thursday"> T</label>
          <label><input type="checkbox" value="Friday"> F</label>
          <label><input type="checkbox" value="Saturday"> S</label>
          <label><input type="checkbox" value="Sunday"> S</label>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn">Save</button>
          <button type="button" class="btn" onclick="closeEditModal('task')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <div id="edit-habit-modal" class="edit-modal">
    <div class="edit-modal-content">
      <span class="close" onclick="closeEditModal('habit')">&times;</span>
      <h2>Edit Habit</h2>
      <form id="edit-habit-form">
        <div class="form-group">
          <label for="edit-habit-description">Description:</label>
          <input type="text" id="edit-habit-description" required />
        </div>
        <div class="form-group">
          <label><strong>Recurrence:</strong></label>
          <div class="recurrence-options">
            <label><input type="radio" name="edit-habit-recurrence" value="none" checked onclick="toggleEditHabitCustomDays(false)"> None</label>
            <label><input type="radio" name="edit-habit-recurrence" value="daily" onclick="toggleEditHabitCustomDays(false)"> Daily</label>
            <label><input type="radio" name="edit-habit-recurrence" value="weekly" onclick="toggleEditHabitCustomDays(false)"> Weekly</label>
            <label><input type="radio" name="edit-habit-recurrence" value="monthly" onclick="toggleEditHabitCustomDays(false)"> Monthly</label>
            <label><input type="radio" name="edit-habit-recurrence" value="custom" onclick="toggleEditHabitCustomDays(true)"> Custom Days</label>
          </div>
        </div>
        <div id="edit-habit-custom-days" class="custom-days" style="display: none;">
          <label><input type="checkbox" value="Monday"> M</label>
          <label><input type="checkbox" value="Tuesday"> T</label>
          <label><input type="checkbox" value="Wednesday"> W</label>
          <label><input type="checkbox" value="Thursday"> T</label>
          <label><input type="checkbox" value="Friday"> F</label>
          <label><input type="checkbox" value="Saturday"> S</label>
          <label><input type="checkbox" value="Sunday"> S</label>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn">Save</button>
          <button type="button" class="btn" onclick="closeEditModal('habit')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <div class="notification" id="notification"></div>
  <footer>
    &copy; 2024-2025 EverCoco. <a href="https://buymeacoffee.com/mpalmero" target="_blank"><i class="fas fa-coffee"></i> Buy me a coffee?</a> All rights reserved.
  </footer>
  <script>
    function generateUUID() {
      let d = new Date().getTime();
      let d2 = (performance && performance.now && (performance.now()*1000)) || 0;
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        let r = Math.random() * 16;
        if(d > 0){
            r = (d + r)%16 | 0;
            d = Math.floor(d/16);
        } else {
            r = (d2 + r)%16 | 0;
            d2 = Math.floor(d2/16);
        }
        return (c==='x' ? r : (r&0x3|0x8)).toString(16);
      });
    }
    let notebooks = [];
    let tags = [];
    let notes = [];
    let tasks = [];
    let habits = [];
    let notifications = [];
    let trashedNotes = [];
    let scratchpadContent = '';
    window.onload = function() {
      loadData();
      ensurePersonalNotebook();
      populateNotebookSelect();
      populateTagSelectors();
      loadScratchpad();
      renderAll();
      resetStreaks();
      initializeNotifications();
      checkUpcomingEvents();
    };
    function loadData() {
      try {
        notebooks = JSON.parse(localStorage.getItem('EverCoco_notebooks')) || [];
      } catch(e) {
        notebooks = [];
      }
      try {
        tags = JSON.parse(localStorage.getItem('EverCoco_tags')) || [];
      } catch(e) {
        tags = [];
      }
      try {
        notes = JSON.parse(localStorage.getItem('EverCoco_notes')) || [];
      } catch(e) {
        notes = [];
      }
      try {
        tasks = JSON.parse(localStorage.getItem('EverCoco_tasks')) || [];
      } catch(e) {
        tasks = [];
      }
      try {
        habits = JSON.parse(localStorage.getItem('EverCoco_habits')) || [];
      } catch(e) {
        habits = [];
      }
      try {
        notifications = JSON.parse(localStorage.getItem('EverCoco_notifications')) || [];
      } catch(e) {
        notifications = [];
      }
      try {
        trashedNotes = JSON.parse(localStorage.getItem('EverCoco_trashedNotes')) || [];
      } catch(e) {
        trashedNotes = [];
      }
      try {
        scratchpadContent = localStorage.getItem('EverCoco_scratchpad') || '';
      } catch(e) {
        scratchpadContent = '';
      }
      tags = tags.map(tag => {
        if (typeof tag === 'string') {
          return { id: generateUUID(), name: tag, favorite: false };
        }
        if (!tag.id) {
          tag.id = generateUUID();
        }
        if (tag.favorite === undefined) tag.favorite = false;
        return tag;
      });
      notebooks.forEach(nb => {
        if (nb.favorite === undefined) nb.favorite = false;
      });
      notes.forEach(note => {
        if (note.favorite === undefined) note.favorite = false;
      });
      tasks.forEach(task => {
        if (task.favorite === undefined) task.favorite = false;
      });
      habits.forEach(habit => {
        if (habit.favorite === undefined) habit.favorite = false;
      });
    }
    function saveData() {
      localStorage.setItem('EverCoco_notebooks', JSON.stringify(notebooks));
      localStorage.setItem('EverCoco_tags', JSON.stringify(tags));
      localStorage.setItem('EverCoco_notes', JSON.stringify(notes));
      localStorage.setItem('EverCoco_tasks', JSON.stringify(tasks));
      localStorage.setItem('EverCoco_habits', JSON.stringify(habits));
      localStorage.setItem('EverCoco_notifications', JSON.stringify(notifications));
      localStorage.setItem('EverCoco_trashedNotes', JSON.stringify(trashedNotes));
      localStorage.setItem('EverCoco_scratchpad', scratchpadContent);
    }
    function ensurePersonalNotebook() {
      const personalExists = notebooks.some(nb => nb.name.toLowerCase() === 'personal');
      if (!personalExists) {
        notebooks.push({ id: generateUUID(), name: 'Personal', favorite: false });
        saveData();
      }
    }
    function populateNotebookSelect() {
      const notebookSelects = document.querySelectorAll('#note-notebook-select, #edit-note-notebook');
      notebookSelects.forEach(select => {
        select.innerHTML = '<option value="">No Notebook</option>';
        notebooks.forEach(nb => {
          const option = document.createElement('option');
          option.value = nb.name;
          option.textContent = nb.name;
          select.appendChild(option);
        });
      });
    }
    function populateTagSelectors() {
      const tagContainers = document.querySelectorAll('.multi-select, #edit-note-tags');
      tagContainers.forEach(container => {
        container.innerHTML = '';
        tags.forEach(tag => {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = tag.name;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(tag.name));
          container.appendChild(label);
        });
      });
    }
    function loadScratchpad() {
      const scratchpad = document.getElementById('scratchpad');
      scratchpad.value = scratchpadContent;
    }
    function saveScratchpad() {
      const scratchpad = document.getElementById('scratchpad');
      scratchpadContent = scratchpad.value;
      saveData();
      showNotification('Scratchpad saved successfully.', 'success');
      addNotification('Scratchpad updated.');
    }
    function renderAll() {
      renderNotebooks();
      renderTags();
      renderNotes();
      renderTasks();
      renderHabits();
      renderDashboardFavorites();
      renderTrash();
    }
    function renderNotebooks() {
      const notebooksList = document.getElementById('notebooks-list');
      notebooksList.innerHTML = '';
      notebooks.forEach(nb => {
        const card = createCard(nb.name || 'Untitled', 'notebooks', nb.id, 'book', nb.favorite, () => toggleFavorite('notebooks', nb.id));
        card.id = `notebook-${nb.id}`;
        const expandIcon = document.createElement('i');
        expandIcon.className = 'fas fa-chevron-right expand-icon';
        card.querySelector('.card-header-left').appendChild(expandIcon);
        const nestedNotesContainer = document.createElement('div');
        nestedNotesContainer.className = 'nested-notes';
        card.appendChild(nestedNotesContainer);
        card.onclick = (e) => {
          if (e.target.closest('.favorite-btn') || e.target.closest('.card-actions')) return;
          const isVisible = nestedNotesContainer.style.display === 'grid';
          nestedNotesContainer.style.display = isVisible ? 'none' : 'grid';
          expandIcon.classList.toggle('expanded', !isVisible);
          if (!isVisible) {
            renderNotesInsideNotebook(nb.id, nestedNotesContainer);
          }
        };
        if (nb.name.toLowerCase() !== 'personal') {
          const actions = createCardActions([
            { icon: 'edit', title: 'Edit', action: () => openEditModal('notebook', nb.id) },
            { icon: 'trash', title: 'Delete', action: () => deleteNotebook(nb.id) }
          ]);
          card.querySelector('.card-header-right').appendChild(actions);
        }
        card.ondblclick = () => {
          if (nb.name.toLowerCase() !== 'personal') {
            openEditModal('notebook', nb.id);
          } else {
            showNotification('The "Personal" notebook cannot be renamed.', 'error');
          }
        };
        notebooksList.appendChild(card);
      });
    }
    function renderTags() {
      const tagsList = document.getElementById('tags-list');
      tagsList.innerHTML = '';
      tags.forEach(tag => {
        const card = createCard(tag.name || 'Untitled', 'tags', tag.id, 'tags', tag.favorite, () => toggleFavorite('tags', tag.id));
        card.id = `tag-${tag.id}`;
        const actions = createCardActions([
          { icon: 'edit', title: 'Edit', action: () => openEditModal('tag', tag.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteTag(tag.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        card.ondblclick = () => {
          openEditModal('tag', tag.id);
        };
        tagsList.appendChild(card);
      });
    }
    function renderNotes(filteredNotes = null) {
      const notesList = document.getElementById('notes-list');
      notesList.innerHTML = '';
      const notesToRender = filteredNotes || notes;
      notesToRender.forEach(note => {
        const card = createCard(note.title || 'Untitled', 'notes', note.id, 'sticky-note', note.favorite, () => toggleFavorite('notes', note.id));
        card.id = `note-${note.id}`;
        const actions = createCardActions([
          { icon: 'edit', title: 'Edit', action: () => openEditModal('note', note.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteNote(note.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (note.body) {
          const snippet = note.body.length > 100 ? note.body.substring(0, 100) + '...' : note.body;
          const body = document.createElement('div');
          body.className = 'details';
          body.textContent = snippet;
          card.appendChild(body);
        }
        if (note.tags.length > 0) {
          const tagDiv = document.createElement('div');
          tagDiv.className = 'details';
          tagDiv.textContent = 'Tags: ' + note.tags.join(', ');
          card.appendChild(tagDiv);
        }
        if (note.notebook) {
          const nbDiv = document.createElement('div');
          nbDiv.className = 'details';
          nbDiv.textContent = 'Notebook: ' + note.notebook;
          card.appendChild(nbDiv);
        }
        if (note.attachments.length > 0) {
          const attachDiv = document.createElement('div');
          attachDiv.className = 'attachments';
          note.attachments.forEach(att => {
            if (att.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = att.data;
              img.alt = att.name;
              attachDiv.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = att.data;
              link.download = att.name;
              link.textContent = att.name;
              attachDiv.appendChild(link);
            }
          });
          card.appendChild(attachDiv);
        }
        card.ondblclick = () => {
          openEditModal('note', note.id);
        };
        notesList.appendChild(card);
      });
    }
    function renderTasks() {
      const tasksList = document.getElementById('tasks-list');
      tasksList.innerHTML = '';
      tasks.forEach(task => {
        const card = createCard(task.description || 'Untitled', 'tasks', task.id, 'tasks', task.favorite, () => toggleFavorite('tasks', task.id));
        card.id = `task-${task.id}`;
        const actions = createCardActions([
          { icon: task.completed ? 'undo' : 'check', title: task.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleTaskCompletion(task.id) },
          { icon: 'edit', title: 'Edit', action: () => openEditModal('task', task.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteTask(task.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (task.dueDate) {
          const dueDate = document.createElement('div');
          dueDate.className = 'details';
          dueDate.textContent = 'Due: ' + task.dueDate;
          card.appendChild(dueDate);
        }
        if (task.recurrence !== 'none') {
          const recurrence = document.createElement('div');
          recurrence.className = 'details';
          recurrence.textContent = 'Recurs: ' + formatRecurrence(task);
          card.appendChild(recurrence);
        }
        card.ondblclick = () => {
          openEditModal('task', task.id);
        };
        tasksList.appendChild(card);
      });
    }
    function renderHabits() {
      const habitsList = document.getElementById('habits-list');
      habitsList.innerHTML = '';
      habits.forEach(habit => {
        const card = createCard(habit.description || 'Untitled', 'habits', habit.id, 'heartbeat', habit.favorite, () => toggleFavorite('habits', habit.id));
        card.id = `habit-${habit.id}`;
        const actions = createCardActions([
          { icon: habit.completed ? 'undo' : 'check', title: habit.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleHabitCompletion(habit.id) },
          { icon: 'edit', title: 'Edit', action: () => openEditModal('habit', habit.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteHabit(habit.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (habit.recurrence !== 'none') {
          const recurDiv = document.createElement('div');
          recurDiv.className = 'details';
          recurDiv.textContent = 'Recurs: ' + formatRecurrence(habit);
          card.appendChild(recurDiv);
        }
        card.ondblclick = () => {
          openEditModal('habit', habit.id);
        };
        habitsList.appendChild(card);
      });
    }
    function createCard(title, type, identifier, icon, favorite, favoriteAction) {
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'card-header';
      const headerLeft = document.createElement('div');
      headerLeft.className = 'card-header-left';
      if (icon) {
        const iconElem = document.createElement('i');
        iconElem.className = `fas fa-${icon}`;
        headerLeft.appendChild(iconElem);
      }
      const titleSpan = document.createElement('span');
      titleSpan.className = 'title';
      titleSpan.textContent = title;
      headerLeft.appendChild(titleSpan);
      header.appendChild(headerLeft);
      const headerRight = document.createElement('div');
      headerRight.className = 'card-header-right';
      const favoriteBtn = document.createElement('button');
      favoriteBtn.className = 'favorite-btn';
      favoriteBtn.title = favorite ? 'Unfavorite' : 'Favorite';
      favoriteBtn.innerHTML = favorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
      favoriteBtn.onclick = (e) => {
        e.stopPropagation();
        favoriteAction();
      };
      headerRight.appendChild(favoriteBtn);
      header.appendChild(headerRight);
      card.appendChild(header);
      return card;
    }
    function createCardActions(actionsArray) {
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'card-actions';
      actionsArray.forEach(actionObj => {
        const btn = document.createElement('button');
        btn.title = actionObj.title;
        btn.innerHTML = `<i class="fas fa-${actionObj.icon}"></i>`;
        btn.onclick = (e) => {
          e.stopPropagation();
          actionObj.action();
        };
        actionsDiv.appendChild(btn);
      });
      return actionsDiv;
    }
    function formatRecurrence(item) {
      if (item.recurrence === 'daily') return 'Daily';
      if (item.recurrence === 'weekly') return 'Weekly';
      if (item.recurrence === 'monthly') return 'Monthly';
      if (item.recurrence === 'custom') return 'Custom Days (' + item.customDays.join(', ') + ')';
      return 'None';
    }
    function renderNotesInsideNotebook(notebookId, container) {
      container.innerHTML = '';
      const notebook = notebooks.find(nb => nb.id === notebookId);
      if (!notebook) return;
      const associatedNotes = notes.filter(note => note.notebook === notebook.name);
      if (associatedNotes.length === 0) {
        container.innerHTML = '<p style="color: #555; font-size: 0.8rem;">No notes in this notebook.</p>';
        return;
      }
      associatedNotes.forEach(note => {
        const noteCard = document.createElement('div');
        noteCard.className = 'nested-note-card';
        noteCard.title = note.title || 'Untitled Note';
        const noteTitle = document.createElement('div');
        noteTitle.className = 'nested-note-title';
        noteTitle.textContent = note.title || 'Untitled';
        noteCard.appendChild(noteTitle);
        if (note.body) {
          const noteSnippet = document.createElement('div');
          noteSnippet.className = 'nested-note-snippet';
          noteSnippet.textContent = note.body.length > 50 ? note.body.substring(0, 50) + '...' : note.body;
          noteCard.appendChild(noteSnippet);
        }
        noteCard.onclick = () => {
          navigate('notes', `note-${note.id}`);
          closeSearch();
        };
        container.appendChild(noteCard);
      });
    }
    function addNotebook() {
      const input = document.getElementById('new-notebook-input');
      const name = input.value.trim();
      if (!name) {
        showNotification('Notebook name cannot be empty.', 'error');
        return;
      }
      if (notebooks.some(nb => nb.name.toLowerCase() === name.toLowerCase())) {
        showNotification('Notebook with this name already exists.', 'error');
        return;
      }
      notebooks.push({ id: generateUUID(), name, favorite: false });
      input.value = '';
      saveData();
      populateNotebookSelect();
      renderNotebooks();
      renderDashboardFavorites();
      showNotification('Notebook added successfully.', 'success');
      addNotification(`Notebook "${name}" created.`);
    }
    function deleteNotebook(id) {
      const notebook = notebooks.find(nb => nb.id === id);
      if (!notebook) return;
      if (notebook.name.toLowerCase() === 'personal') {
        showNotification('The "Personal" notebook cannot be deleted.', 'error');
        return;
      }
      if (confirm(`Are you sure you want to delete the notebook "${notebook.name}"?`)) {
        notebooks = notebooks.filter(nb => nb.id !== id);
        notes = notes.map(note => {
          if (note.notebook === notebook.name) {
            return { ...note, notebook: '', favorite: note.favorite };
          }
          return note;
        });
        saveData();
        populateNotebookSelect();
        renderNotebooks();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Notebook deleted.', 'success');
        addNotification(`Notebook "${notebook.name}" deleted.`);
      }
    }
    function openEditModal(type, id) {
      switch(type) {
        case 'notebook':
          openEditNotebookModal(id);
          break;
        case 'tag':
          openEditTagModal(id);
          break;
        case 'note':
          openEditNoteModal(id);
          break;
        case 'task':
          openEditTaskModal(id);
          break;
        case 'habit':
          openEditHabitModal(id);
          break;
      }
    }
    function closeEditModal(type) {
      switch(type) {
        case 'notebook':
          document.getElementById('edit-notebook-modal').style.display = 'none';
          break;
        case 'tag':
          document.getElementById('edit-tag-modal').style.display = 'none';
          break;
        case 'note':
          document.getElementById('edit-note-modal').style.display = 'none';
          break;
        case 'task':
          document.getElementById('edit-task-modal').style.display = 'none';
          break;
        case 'habit':
          document.getElementById('edit-habit-modal').style.display = 'none';
          break;
      }
    }
    function openEditNotebookModal(id) {
      const notebook = notebooks.find(nb => nb.id === id);
      if (!notebook) return;
      document.getElementById('edit-notebook-name').value = notebook.name;
      document.getElementById('edit-notebook-form').setAttribute('data-id', id);
      document.getElementById('edit-notebook-modal').style.display = 'block';
    }
    document.getElementById('edit-notebook-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = this.getAttribute('data-id');
      const newName = document.getElementById('edit-notebook-name').value.trim();
      if (!newName) {
        showNotification('Notebook name cannot be empty.', 'error');
        return;
      }
      if (notebooks.some(nb => nb.name.toLowerCase() === newName.toLowerCase() && nb.id !== id)) {
        showNotification('Another notebook with this name already exists.', 'error');
        return;
      }
      const notebook = notebooks.find(nb => nb.id === id);
      if (!notebook) return;
      const oldName = notebook.name;
      notebook.name = newName;
      notes = notes.map(note => {
        if (note.notebook === oldName) {
          return { ...note, notebook: newName };
        }
        return note;
      });
      saveData();
      populateNotebookSelect();
      renderNotebooks();
      renderNotes();
      renderDashboardFavorites();
      closeEditModal('notebook');
      showNotification('Notebook updated.', 'success');
      addNotification(`Notebook "${oldName}" renamed to "${newName}".`);
    });
    function openEditTagModal(id) {
      const tag = tags.find(t => t.id === id);
      if (!tag) return;
      document.getElementById('edit-tag-name').value = tag.name;
      document.getElementById('edit-tag-form').setAttribute('data-id', id);
      document.getElementById('edit-tag-modal').style.display = 'block';
    }
    document.getElementById('edit-tag-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = this.getAttribute('data-id');
      const newName = document.getElementById('edit-tag-name').value.trim();
      if (!newName) {
        showNotification('Tag name cannot be empty.', 'error');
        return;
      }
      if (tags.some(t => t.name.toLowerCase() === newName.toLowerCase() && t.id !== id)) {
        showNotification('Tag already exists.', 'error');
        return;
      }
      const tag = tags.find(t => t.id === id);
      if (!tag) return;
      const oldName = tag.name;
      tag.name = newName;
      notes = notes.map(note => {
        if (note.tags.includes(oldName)) {
          return { ...note, tags: note.tags.map(t => t === oldName ? newName : t) };
        }
        return note;
      });
      saveData();
      populateTagSelectors();
      renderTags();
      renderNotes();
      renderDashboardFavorites();
      closeEditModal('tag');
      showNotification('Tag updated.', 'success');
      addNotification(`Tag "${oldName}" renamed to "${newName}".`);
    });
    function openEditNoteModal(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      document.getElementById('edit-note-title').value = note.title || '';
      document.getElementById('edit-note-body').value = note.body || '';
      const editNoteTagsContainer = document.getElementById('edit-note-tags');
      editNoteTagsContainer.innerHTML = '';
      tags.forEach(tag => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = tag.name;
        if (note.tags.includes(tag.name)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(tag.name));
        editNoteTagsContainer.appendChild(label);
      });
      document.getElementById('edit-note-new-tags').value = '';
      const editNoteNotebookSelect = document.getElementById('edit-note-notebook');
      editNoteNotebookSelect.innerHTML = '<option value="">No Notebook</option>';
      notebooks.forEach(nb => {
        const option = document.createElement('option');
        option.value = nb.name;
        option.textContent = nb.name;
        if (nb.name === note.notebook) option.selected = true;
        editNoteNotebookSelect.appendChild(option);
      });
      document.getElementById('edit-note-attachments').value = '';
      document.getElementById('edit-note-form').setAttribute('data-id', id);
      document.getElementById('edit-note-modal').style.display = 'block';
    }
    document.getElementById('edit-note-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = this.getAttribute('data-id');
      const title = document.getElementById('edit-note-title').value.trim();
      const body = document.getElementById('edit-note-body').value.trim();
      const tagsContainer = document.getElementById('edit-note-tags');
      const newTagsInput = document.getElementById('edit-note-new-tags');
      const notebookSelect = document.getElementById('edit-note-notebook');
      const attachmentsInput = document.getElementById('edit-note-attachments');
      const selectedTags = Array.from(tagsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const newTags = newTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      let allNoteTags = [...selectedTags, ...newTags];
      allNoteTags = [...new Set(allNoteTags)];
      newTags.forEach(tag => {
        if (!tags.some(t => t.name.toLowerCase() === tag.toLowerCase())) {
          tags.push({ id: generateUUID(), name: tag, favorite: false });
        }
      });
      const notebook = notebookSelect.value;
      const attachments = [];
      const files = attachmentsInput.files;
      const validFileTypes = [
        'image/jpeg','image/png','image/gif','application/pdf','application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document','text/plain'
      ];
      if (files.length > 0) {
        let filesProcessed = 0;
        for (let file of files) {
          if (file.size > 2 * 1024 * 1024) {
            showNotification(`File "${file.name}" exceeds 2MB limit.`, 'error');
            filesProcessed++;
            if (filesProcessed === files.length) finalizeEditNote();
            continue;
          }
          if (!validFileTypes.includes(file.type)) {
            showNotification(`File type "${file.name}" not supported.`, 'error');
            filesProcessed++;
            if (filesProcessed === files.length) finalizeEditNote();
            continue;
          }
          const reader = new FileReader();
          reader.onload = function(e2) {
            attachments.push({ name: file.name, type: file.type, data: e2.target.result });
            filesProcessed++;
            if (filesProcessed === files.length) finalizeEditNote();
          };
          reader.readAsDataURL(file);
        }
      } else {
        finalizeEditNote();
      }
      function finalizeEditNote() {
        const note = notes.find(n => n.id === id);
        if (!note) return;
        note.title = title || 'Untitled';
        note.body = body;
        note.tags = allNoteTags;
        note.notebook = notebook;
        if (attachments.length > 0) {
          note.attachments = note.attachments.concat(attachments);
        }
        saveData();
        populateTagSelectors();
        renderTags();
        renderNotes();
        renderDashboardFavorites();
        closeEditModal('note');
        showNotification('Note updated.', 'success');
        addNotification(`Note "${title || 'Untitled'}" edited.`);
      }
    });
    function openEditTaskModal(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      document.getElementById('edit-task-description').value = task.description;
      document.getElementById('edit-task-due-date').value = task.dueDate || '';
      const recurrenceRadios = document.getElementsByName('edit-task-recurrence');
      recurrenceRadios.forEach(radio => {
        if (radio.value === task.recurrence) radio.checked = true;
      });
      toggleEditTaskCustomDays(task.recurrence === 'custom');
      const editTaskCustomDaysDiv = document.getElementById('edit-task-custom-days');
      editTaskCustomDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = task.customDays.includes(cb.value);
      });
      document.getElementById('edit-task-form').setAttribute('data-id', id);
      document.getElementById('edit-task-modal').style.display = 'block';
    }
    function toggleEditTaskCustomDays(show) {
      const customDaysDiv = document.getElementById('edit-task-custom-days');
      if (show) {
        customDaysDiv.style.display = 'flex';
      } else {
        customDaysDiv.style.display = 'none';
        customDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    }
    document.getElementById('edit-task-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = this.getAttribute('data-id');
      const description = document.getElementById('edit-task-description').value.trim();
      const dueDate = document.getElementById('edit-task-due-date').value;
      const recurrenceRadios = document.getElementsByName('edit-task-recurrence');
      let recurrence = 'none';
      recurrenceRadios.forEach(r => {
        if (r.checked) recurrence = r.value;
      });
      let customDays = [];
      if (recurrence === 'custom') {
        const checkboxes = document.getElementById('edit-task-custom-days').querySelectorAll('input[type="checkbox"]:checked');
        customDays = Array.from(checkboxes).map(cb => cb.value);
        if (customDays.length === 0) {
          showNotification('Select at least one day for custom recurrence.', 'error');
          return;
        }
      }
      if (!description) {
        showNotification('Task description cannot be empty.', 'error');
        return;
      }
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      const oldDescription = task.description;
      task.description = description;
      task.dueDate = dueDate;
      task.recurrence = recurrence;
      task.customDays = recurrence === 'custom' ? customDays : [];
      saveData();
      renderTasks();
      renderDashboardFavorites();
      closeEditModal('task');
      showNotification('Task updated.', 'success');
      addNotification(`Task "${oldDescription}" edited.`);
    });
    function openEditHabitModal(id) {
      const habit = habits.find(h => h.id === id);
      if (!habit) return;
      document.getElementById('edit-habit-description').value = habit.description;
      const recurrenceRadios = document.getElementsByName('edit-habit-recurrence');
      recurrenceRadios.forEach(r => {
        if (r.value === habit.recurrence) r.checked = true;
      });
      toggleEditHabitCustomDays(habit.recurrence === 'custom');
      const editHabitCustomDaysDiv = document.getElementById('edit-habit-custom-days');
      editHabitCustomDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = habit.customDays.includes(cb.value);
      });
      document.getElementById('edit-habit-form').setAttribute('data-id', id);
      document.getElementById('edit-habit-modal').style.display = 'block';
    }
    function toggleEditHabitCustomDays(show) {
      const customDaysDiv = document.getElementById('edit-habit-custom-days');
      if (show) {
        customDaysDiv.style.display = 'flex';
      } else {
        customDaysDiv.style.display = 'none';
        customDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    }
    document.getElementById('edit-habit-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = this.getAttribute('data-id');
      const description = document.getElementById('edit-habit-description').value.trim();
      const recurrenceRadios = document.getElementsByName('edit-habit-recurrence');
      let recurrence = 'none';
      recurrenceRadios.forEach(r => {
        if (r.checked) recurrence = r.value;
      });
      let customDays = [];
      if (recurrence === 'custom') {
        const checkboxes = document.getElementById('edit-habit-custom-days').querySelectorAll('input[type="checkbox"]:checked');
        customDays = Array.from(checkboxes).map(cb => cb.value);
        if (customDays.length === 0) {
          showNotification('Select at least one day for custom recurrence.', 'error');
          return;
        }
      }
      if (!description) {
        showNotification('Habit description cannot be empty.', 'error');
        return;
      }
      const habit = habits.find(h => h.id === id);
      if (!habit) return;
      const oldDescription = habit.description;
      habit.description = description;
      habit.recurrence = recurrence;
      habit.customDays = recurrence === 'custom' ? customDays : [];
      saveData();
      renderHabits();
      renderDashboardFavorites();
      closeEditModal('habit');
      showNotification('Habit updated.', 'success');
      addNotification(`Habit "${oldDescription}" edited.`);
    });
    function addTag() {
      const input = document.getElementById('new-tag-input');
      const name = input.value.trim();
      if (!name) {
        showNotification('Tag name cannot be empty.', 'error');
        return;
      }
      if (tags.some(tag => tag.name.toLowerCase() === name.toLowerCase())) {
        showNotification('Tag already exists.', 'error');
        return;
      }
      tags.push({ id: generateUUID(), name, favorite: false });
      input.value = '';
      saveData();
      populateTagSelectors();
      renderTags();
      renderDashboardFavorites();
      showNotification('Tag added.', 'success');
      addNotification(`Tag "${name}" created.`);
    }
    function deleteTag(id) {
      const tag = tags.find(t => t.id === id);
      if (!tag) return;
      if (confirm(`Delete tag "${tag.name}"? It will be removed from all notes.`)) {
        tags = tags.filter(t => t.id !== id);
        notes = notes.map(note => {
          if (note.tags.includes(tag.name)) {
            return { ...note, tags: note.tags.filter(tg => tg !== tag.name) };
          }
          return note;
        });
        saveData();
        populateTagSelectors();
        renderTags();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Tag deleted.', 'success');
        addNotification(`Tag "${tag.name}" deleted.`);
      }
    }
    function addNote() {
      const titleInput = document.getElementById('note-title');
      const bodyInput = document.getElementById('note-body');
      const tagsContainer = document.getElementById('note-tags');
      const newTagsInput = document.getElementById('note-new-tags');
      const notebookSelect = document.getElementById('note-notebook-select');
      const attachmentsInput = document.getElementById('note-attachments');
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();
      const selectedTags = Array.from(tagsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const newTags = newTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      let allNoteTags = [...selectedTags, ...newTags];
      allNoteTags = [...new Set(allNoteTags)];
      newTags.forEach(tag => {
        if (!tags.some(t => t.name.toLowerCase() === tag.toLowerCase())) {
          tags.push({ id: generateUUID(), name: tag, favorite: false });
        }
      });
      const notebook = notebookSelect.value;
      const attachments = [];
      const files = attachmentsInput.files;
      const validFileTypes = [
        'image/jpeg','image/png','image/gif','application/pdf','application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document','text/plain'
      ];
      if (files.length > 0) {
        let filesProcessed = 0;
        for (let file of files) {
          if (file.size > 2 * 1024 * 1024) {
            showNotification(`File "${file.name}" exceeds 2MB limit.`, 'error');
            filesProcessed++;
            if (filesProcessed === files.length) finalizeAddNote();
            continue;
          }
          if (!validFileTypes.includes(file.type)) {
            showNotification(`File type "${file.name}" not supported.`, 'error');
            filesProcessed++;
            if (filesProcessed === files.length) finalizeAddNote();
            continue;
          }
          const reader = new FileReader();
          reader.onload = function(e2) {
            attachments.push({ name: file.name, type: file.type, data: e2.target.result });
            filesProcessed++;
            if (filesProcessed === files.length) finalizeAddNote();
          };
          reader.readAsDataURL(file);
        }
      } else {
        finalizeAddNote();
      }
      function finalizeAddNote() {
        const note = {
          id: generateUUID(),
          title,
          body,
          tags: allNoteTags,
          notebook,
          attachments,
          favorite: false
        };
        notes.push(note);
        saveData();
        populateTagSelectors();
        renderTags();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Note added.', 'success');
        addNotification(`Note "${title || 'Untitled'}" created.`);
        clearNoteForm();
      }
      function clearNoteForm() {
        titleInput.value = '';
        bodyInput.value = '';
        newTagsInput.value = '';
        tagsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        notebookSelect.value = '';
        attachmentsInput.value = '';
      }
    }
    function deleteNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      if (confirm('Delete this note? It will be moved to Trash.')) {
        notes = notes.filter(n => n.id !== id);
        trashedNotes.unshift(note);
        saveData();
        renderNotes();
        renderDashboardFavorites();
        renderTrash();
        showNotification('Note moved to Trash.', 'success');
        addNotification(`Note "${note.title || 'Untitled'}" moved to Trash.`);
      }
    }
    function addTask() {
      const descInput = document.getElementById('task-input');
      const dueDateInput = document.getElementById('task-due-date');
      const recurrenceRadios = document.getElementsByName('task-recurrence');
      const customDaysDiv = document.getElementById('task-custom-days');
      const description = descInput.value.trim();
      const dueDate = dueDateInput.value;
      let recurrence = 'none';
      recurrenceRadios.forEach(radio => {
        if (radio.checked) recurrence = radio.value;
      });
      let customDays = [];
      if (recurrence === 'custom') {
        const checkboxes = customDaysDiv.querySelectorAll('input[type="checkbox"]:checked');
        customDays = Array.from(checkboxes).map(cb => cb.value);
        if (customDays.length === 0) {
          showNotification('Select at least one day for custom recurrence.', 'error');
          return;
        }
      }
      if (!description) {
        showNotification('Task description cannot be empty.', 'error');
        return;
      }
      const task = {
        id: generateUUID(),
        description,
        dueDate,
        recurrence,
        customDays,
        completed: false,
        streak: 0,
        lastCompleted: null,
        favorite: false
      };
      tasks.push(task);
      saveData();
      renderTasks();
      renderDashboardFavorites();
      showNotification('Task added.', 'success');
      addNotification(`Task "${description}" created.`);
      clearTaskForm();
    }
    function clearTaskForm() {
      document.getElementById('task-input').value = '';
      document.getElementById('task-due-date').value = '';
      document.querySelectorAll('input[name="task-recurrence"]').forEach(r => r.checked = false);
      document.querySelector('input[name="task-recurrence"][value="none"]').checked = true;
      toggleTaskCustomDays(false);
    }
    function toggleTaskCustomDays(show) {
      const customDaysDiv = document.getElementById('task-custom-days');
      if (show) {
        customDaysDiv.style.display = 'flex';
      } else {
        customDaysDiv.style.display = 'none';
        customDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    }
    function toggleTaskCompletion(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.completed = !task.completed;
      if (task.completed) {
        task.lastCompleted = new Date().toDateString();
        task.streak += 1;
        showNotification('Task marked complete.', 'success');
        addNotification(`Task "${task.description}" marked complete.`);
      } else {
        task.lastCompleted = null;
        if (task.streak > 0) task.streak -= 1;
        showNotification('Task marked incomplete.', 'success');
        addNotification(`Task "${task.description}" marked incomplete.`);
      }
      saveData();
      renderTasks();
      renderDashboardFavorites();
    }
    function deleteTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      if (confirm('Delete this task?')) {
        tasks = tasks.filter(t => t.id !== id);
        saveData();
        renderTasks();
        renderDashboardFavorites();
        showNotification('Task deleted.', 'success');
        addNotification(`Task "${task.description}" deleted.`);
      }
    }
    function addHabit() {
      const descInput = document.getElementById('habit-input');
      const recurrenceRadios = document.getElementsByName('habit-recurrence');
      const customDaysDiv = document.getElementById('habit-custom-days');
      const description = descInput.value.trim();
      if (!description) {
        showNotification('Habit description cannot be empty.', 'error');
        return;
      }
      let recurrence = 'none';
      recurrenceRadios.forEach(radio => {
        if (radio.checked) recurrence = radio.value;
      });
      let customDays = [];
      if (recurrence === 'custom') {
        const checkboxes = customDaysDiv.querySelectorAll('input[type="checkbox"]:checked');
        customDays = Array.from(checkboxes).map(cb => cb.value);
        if (customDays.length === 0) {
          showNotification('Select at least one day for custom recurrence.', 'error');
          return;
        }
      }
      const habit = {
        id: generateUUID(),
        description,
        recurrence,
        customDays,
        completed: false,
        streak: 0,
        lastCompleted: null,
        favorite: false
      };
      habits.push(habit);
      saveData();
      renderHabits();
      renderDashboardFavorites();
      showNotification('Habit added.', 'success');
      addNotification(`Habit "${description}" created.`);
      clearHabitForm();
    }
    function clearHabitForm() {
      document.getElementById('habit-input').value = '';
      document.querySelectorAll('input[name="habit-recurrence"]').forEach(r => r.checked = false);
      document.querySelector('input[name="habit-recurrence"][value="none"]').checked = true;
      toggleHabitCustomDays(false);
    }
    function toggleHabitCustomDays(show) {
      const customDaysDiv = document.getElementById('habit-custom-days');
      if (show) {
        customDaysDiv.style.display = 'flex';
      } else {
        customDaysDiv.style.display = 'none';
        customDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    }
    function toggleHabitCompletion(id) {
      const habit = habits.find(h => h.id === id);
      if (!habit) return;
      habit.completed = !habit.completed;
      if (habit.completed) {
        habit.lastCompleted = new Date().toDateString();
        habit.streak += 1;
        showNotification('Habit marked complete.', 'success');
        addNotification(`Habit "${habit.description}" marked complete.`);
      } else {
        habit.lastCompleted = null;
        if (habit.streak > 0) habit.streak -= 1;
        showNotification('Habit marked incomplete.', 'success');
        addNotification(`Habit "${habit.description}" marked incomplete.`);
      }
      saveData();
      renderHabits();
      renderDashboardFavorites();
    }
    function deleteHabit(id) {
      const habit = habits.find(h => h.id === id);
      if (!habit) return;
      if (confirm('Delete this habit?')) {
        habits = habits.filter(h => h.id !== id);
        saveData();
        renderHabits();
        renderDashboardFavorites();
        showNotification('Habit deleted.', 'success');
        addNotification(`Habit "${habit.description}" deleted.`);
      }
    }
    function toggleFavorite(type, identifier) {
      switch(type) {
        case 'notebooks':
          const notebook = notebooks.find(nb => nb.id === identifier);
          if (notebook) {
            notebook.favorite = !notebook.favorite;
            if (notebook.favorite) {
              addNotification(`Notebook "${notebook.name}" favorited.`);
            } else {
              addNotification(`Notebook "${notebook.name}" unfavorited.`);
            }
          }
          break;
        case 'tags':
          const tag = tags.find(t => t.id === identifier);
          if (tag) {
            tag.favorite = !tag.favorite;
            if (tag.favorite) {
              addNotification(`Tag "${tag.name}" favorited.`);
            } else {
              addNotification(`Tag "${tag.name}" unfavorited.`);
            }
          }
          break;
        case 'notes':
          const note = notes.find(n => n.id === identifier);
          if (note) {
            note.favorite = !note.favorite;
            if (note.favorite) {
              addNotification(`Note "${note.title || 'Untitled'}" favorited.`);
            } else {
              addNotification(`Note "${note.title || 'Untitled'}" unfavorited.`);
            }
          }
          break;
        case 'tasks':
          const task = tasks.find(t => t.id === identifier);
          if (task) {
            task.favorite = !task.favorite;
            if (task.favorite) {
              addNotification(`Task "${task.description}" favorited.`);
            } else {
              addNotification(`Task "${task.description}" unfavorited.`);
            }
          }
          break;
        case 'habits':
          const habit = habits.find(h => h.id === identifier);
          if (habit) {
            habit.favorite = !habit.favorite;
            if (habit.favorite) {
              addNotification(`Habit "${habit.description}" favorited.`);
            } else {
              addNotification(`Habit "${habit.description}" unfavorited.`);
            }
          }
          break;
      }
      saveData();
      renderAll();
      showNotification('Favorite status updated.', 'success');
    }
    function renderDashboardFavorites() {
      renderFavoriteNotebooks();
      renderFavoriteTags();
      renderFavoriteNotes();
      renderFavoriteTasks();
      renderFavoriteHabits();
    }
    function renderFavoriteNotebooks() {
      const favNotebooksList = document.getElementById('favorites-dashboard-notebooks-list');
      favNotebooksList.innerHTML = '';
      const favoriteNotebooks = notebooks.filter(nb => nb.favorite);
      if (favoriteNotebooks.length === 0) {
        favNotebooksList.innerHTML = '<p>No favorite notebooks.</p>';
        return;
      }
      favoriteNotebooks.forEach(nb => {
        const card = createCard(nb.name || 'Untitled', 'notebooks', nb.id, 'book', nb.favorite, () => toggleFavorite('notebooks', nb.id));
        card.id = `notebook-${nb.id}`;
        const expandIcon = document.createElement('i');
        expandIcon.className = 'fas fa-chevron-right expand-icon';
        card.querySelector('.card-header-left').appendChild(expandIcon);
        const nestedNotesContainer = document.createElement('div');
        nestedNotesContainer.className = 'nested-notes';
        card.appendChild(nestedNotesContainer);
        card.onclick = (e) => {
          if (e.target.closest('.favorite-btn') || e.target.closest('.card-actions')) return;
          const isVisible = nestedNotesContainer.style.display === 'grid';
          nestedNotesContainer.style.display = isVisible ? 'none' : 'grid';
          expandIcon.classList.toggle('expanded', !isVisible);
          if (!isVisible) {
            renderNotesInsideNotebook(nb.id, nestedNotesContainer);
          }
        };
        if (nb.name.toLowerCase() !== 'personal') {
          const actions = createCardActions([
            { icon: 'edit', title: 'Edit', action: () => openEditModal('notebook', nb.id) },
            { icon: 'trash', title: 'Delete', action: () => deleteNotebook(nb.id) }
          ]);
          card.querySelector('.card-header-right').appendChild(actions);
        }
        card.ondblclick = () => {
          if (nb.name.toLowerCase() !== 'personal') {
            openEditModal('notebook', nb.id);
          } else {
            showNotification('Cannot rename "Personal" notebook.', 'error');
          }
        };
        favNotebooksList.appendChild(card);
      });
    }
    function renderFavoriteTags() {
      const favTagsList = document.getElementById('favorites-dashboard-tags-list');
      favTagsList.innerHTML = '';
      const favoriteTags = tags.filter(tag => tag.favorite);
      if (favoriteTags.length === 0) {
        favTagsList.innerHTML = '<p>No favorite tags.</p>';
        return;
      }
      favoriteTags.forEach(tag => {
        const card = createCard(tag.name || 'Untitled', 'tags', tag.id, 'tags', tag.favorite, () => toggleFavorite('tags', tag.id));
        card.id = `tag-${tag.id}`;
        const actions = createCardActions([
          { icon: 'edit', title: 'Edit', action: () => openEditModal('tag', tag.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteTag(tag.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        card.ondblclick = () => {
          openEditModal('tag', tag.id);
        };
        favTagsList.appendChild(card);
      });
    }
    function renderFavoriteNotes() {
      const favNotesList = document.getElementById('favorites-dashboard-notes-list');
      favNotesList.innerHTML = '';
      const favoriteNotes = notes.filter(note => note.favorite);
      if (favoriteNotes.length === 0) {
        favNotesList.innerHTML = '<p>No favorite notes.</p>';
        return;
      }
      favoriteNotes.forEach(note => {
        const card = createCard(note.title || 'Untitled', 'notes', note.id, 'sticky-note', note.favorite, () => toggleFavorite('notes', note.id));
        card.id = `note-${note.id}`;
        const actions = createCardActions([
          { icon: 'edit', title: 'Edit', action: () => openEditModal('note', note.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteNote(note.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (note.body) {
          const snippet = note.body.length > 100 ? note.body.substring(0, 100) + '...' : note.body;
          const body = document.createElement('div');
          body.className = 'details';
          body.textContent = snippet;
          card.appendChild(body);
        }
        if (note.tags.length > 0) {
          const tagDiv = document.createElement('div');
          tagDiv.className = 'details';
          tagDiv.textContent = 'Tags: ' + note.tags.join(', ');
          card.appendChild(tagDiv);
        }
        if (note.notebook) {
          const nbDiv = document.createElement('div');
          nbDiv.className = 'details';
          nbDiv.textContent = 'Notebook: ' + note.notebook;
          card.appendChild(nbDiv);
        }
        if (note.attachments.length > 0) {
          const attachDiv = document.createElement('div');
          attachDiv.className = 'attachments';
          note.attachments.forEach(att => {
            if (att.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = att.data;
              img.alt = att.name;
              attachDiv.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = att.data;
              link.download = att.name;
              link.textContent = att.name;
              attachDiv.appendChild(link);
            }
          });
          card.appendChild(attachDiv);
        }
        card.ondblclick = () => {
          openEditModal('note', note.id);
        };
        favNotesList.appendChild(card);
      });
    }
    function renderFavoriteTasks() {
      const favTasksList = document.getElementById('favorites-dashboard-tasks-list');
      favTasksList.innerHTML = '';
      const favoriteTasks = tasks.filter(task => task.favorite);
      if (favoriteTasks.length === 0) {
        favTasksList.innerHTML = '<p>No favorite tasks.</p>';
        return;
      }
      favoriteTasks.forEach(task => {
        const card = createCard(task.description || 'Untitled', 'tasks', task.id, 'tasks', task.favorite, () => toggleFavorite('tasks', task.id));
        card.id = `task-${task.id}`;
        const actions = createCardActions([
          { icon: task.completed ? 'undo' : 'check', title: task.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleTaskCompletion(task.id) },
          { icon: 'edit', title: 'Edit', action: () => openEditModal('task', task.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteTask(task.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (task.dueDate) {
          const dueDate = document.createElement('div');
          dueDate.className = 'details';
          dueDate.textContent = 'Due: ' + task.dueDate;
          card.appendChild(dueDate);
        }
        if (task.recurrence !== 'none') {
          const recurrence = document.createElement('div');
          recurrence.className = 'details';
          recurrence.textContent = 'Recurs: ' + formatRecurrence(task);
          card.appendChild(recurrence);
        }
        card.ondblclick = () => {
          openEditModal('task', task.id);
        };
        favTasksList.appendChild(card);
      });
    }
    function renderFavoriteHabits() {
      const favHabitsList = document.getElementById('favorites-dashboard-habits-list');
      favHabitsList.innerHTML = '';
      const favoriteHabits = habits.filter(habit => habit.favorite);
      if (favoriteHabits.length === 0) {
        favHabitsList.innerHTML = '<p>No favorite habits.</p>';
        return;
      }
      favoriteHabits.forEach(habit => {
        const card = createCard(habit.description || 'Untitled', 'habits', habit.id, 'heartbeat', habit.favorite, () => toggleFavorite('habits', habit.id));
        card.id = `habit-${habit.id}`;
        const actions = createCardActions([
          { icon: habit.completed ? 'undo' : 'check', title: habit.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleHabitCompletion(habit.id) },
          { icon: 'edit', title: 'Edit', action: () => openEditModal('habit', habit.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteHabit(habit.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (habit.recurrence !== 'none') {
          const recurDiv = document.createElement('div');
          recurDiv.className = 'details';
          recurDiv.textContent = 'Recurs: ' + formatRecurrence(habit);
          card.appendChild(recurDiv);
        }
        card.ondblclick = () => {
          openEditModal('habit', habit.id);
        };
        favHabitsList.appendChild(card);
      });
    }
    function renderTrash() {
      const trashList = document.getElementById('trash-list');
      trashList.innerHTML = '';
      if (trashedNotes.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.textContent = 'Trash is empty.';
        emptyMessage.style.color = '#555';
        emptyMessage.style.fontSize = '0.9rem';
        trashList.appendChild(emptyMessage);
        return;
      }
      trashedNotes.forEach(note => {
        const card = createCard(note.title || 'Untitled', 'notes', note.id, 'sticky-note', note.favorite, () => toggleFavorite('notes', note.id));
        card.id = `trash-note-${note.id}`;
        const actions = createCardActions([
          { icon: 'undo', title: 'Restore', action: () => restoreNote(note.id) },
          { icon: 'trash', title: 'Delete Permanently', action: () => permanentlyDeleteNote(note.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);
        if (note.body) {
          const snippet = note.body.length > 100 ? note.body.substring(0, 100) + '...' : note.body;
          const body = document.createElement('div');
          body.className = 'details';
          body.textContent = snippet;
          card.appendChild(body);
        }
        if (note.tags.length > 0) {
          const tagDiv = document.createElement('div');
          tagDiv.className = 'details';
          tagDiv.textContent = 'Tags: ' + note.tags.join(', ');
          card.appendChild(tagDiv);
        }
        if (note.notebook) {
          const nbDiv = document.createElement('div');
          nbDiv.className = 'details';
          nbDiv.textContent = 'Notebook: ' + note.notebook;
          card.appendChild(nbDiv);
        }
        if (note.attachments.length > 0) {
          const attachDiv = document.createElement('div');
          attachDiv.className = 'attachments';
          note.attachments.forEach(att => {
            if (att.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = att.data;
              img.alt = att.name;
              attachDiv.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = att.data;
              link.download = att.name;
              link.textContent = att.name;
              attachDiv.appendChild(link);
            }
          });
          card.appendChild(attachDiv);
        }
        card.ondblclick = () => {
          restoreNote(note.id);
        };
        trashList.appendChild(card);
      });
    }
    function restoreNote(id) {
      const noteIndex = trashedNotes.findIndex(n => n.id === id);
      if (noteIndex === -1) return;
      const note = trashedNotes.splice(noteIndex, 1)[0];
      notes.push(note);
      saveData();
      renderTrash();
      renderNotes();
      renderDashboardFavorites();
      showNotification('Note restored.', 'success');
      addNotification(`Note "${note.title || 'Untitled'}" restored.`);
    }
    function permanentlyDeleteNote(id) {
      const noteIndex = trashedNotes.findIndex(n => n.id === id);
      if (noteIndex === -1) return;
      const note = trashedNotes[noteIndex];
      if (confirm(`Permanently delete note "${note.title || 'Untitled'}"?`)) {
        trashedNotes.splice(noteIndex, 1);
        saveData();
        renderTrash();
        renderDashboardFavorites();
        showNotification('Note permanently deleted.', 'success');
        addNotification(`Note "${note.title || 'Untitled'}" permanently deleted.`);
      }
    }
    function showNotification(message, type) {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.className = 'notification ' + (type === 'error' ? 'error' : 'success');
      notif.classList.add('show');
      setTimeout(() => {
        notif.classList.remove('show');
      }, 3000);
    }
    function navigate(section, itemId = null) {
      const sections = document.querySelectorAll('.kanban-column');
      sections.forEach(sec => {
        if (sec.id === section + '-section') {
          sec.style.display = 'flex';
        } else {
          sec.style.display = 'none';
        }
      });
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        const span = item.querySelector('span');
        if (span && span.textContent.trim().toLowerCase() === section.toLowerCase()) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      if (section === 'trash') {
        renderTrash();
      }
      if (itemId) {
        setTimeout(() => {
          const element = document.getElementById(itemId);
          if (element) {
            const headerOffset = 60;
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            element.style.boxShadow = '0 0 10px 2px rgba(100, 100, 255, 0.7)';
            setTimeout(() => {
              element.style.boxShadow = 'none';
            }, 2000);
          }
        }, 500);
      }
    }
    function resetStreaks() {
      const today = new Date();
      tasks.forEach(task => {
        if (task.lastCompleted) {
          const last = new Date(task.lastCompleted);
          const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));
          if (shouldResetStreak(task.recurrence, diffDays, last, today.toLocaleDateString(undefined, { weekday: 'long' }))) {
            task.streak = 0;
            task.lastCompleted = null;
            addNotification(`Streak reset for task "${task.description}".`);
          }
        }
      });
      habits.forEach(habit => {
        if (habit.lastCompleted) {
          const last = new Date(habit.lastCompleted);
          const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));
          if (shouldResetStreak(habit.recurrence, diffDays, last, today.toLocaleDateString(undefined, { weekday: 'long' }))) {
            habit.streak = 0;
            habit.lastCompleted = null;
            addNotification(`Streak reset for habit "${habit.description}".`);
          }
        }
      });
      saveData();
      renderTasks();
      renderHabits();
      renderDashboardFavorites();
    }
    function shouldResetStreak(recurrence, diffDays, lastDate, todayStr) {
      const today = new Date();
      switch(recurrence) {
        case 'daily':
          return diffDays > 1;
        case 'weekly':
          return diffDays > 7;
        case 'monthly':
          return !(lastDate.getMonth() === today.getMonth() && lastDate.getFullYear() === today.getFullYear());
        case 'custom':
          return false;
        default:
          return false;
      }
    }
    function openSearch() {
      document.getElementById('search-modal').style.display = 'block';
      document.getElementById('search-input').focus();
    }
    function closeSearch() {
      document.getElementById('search-modal').style.display = 'none';
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
    }
    function performSearch() {
      const query = document.getElementById('search-input').value.trim().toLowerCase();
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = '';
      if (query === '') {
        resultsContainer.innerHTML = '<p>Please enter a search term.</p>';
        return;
      }
      function highlight(text) {
        const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
      }
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }
      const matchedNotebooks = notebooks.filter(nb => nb.name.toLowerCase().includes(query));
      if (matchedNotebooks.length > 0) {
        const section = document.createElement('div');
        section.className = 'search-category';
        section.innerHTML = `<h4>Notebooks</h4>`;
        matchedNotebooks.forEach(nb => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(nb.name);
          item.onclick = () => navigate('notebooks', `notebook-${nb.id}`);
          section.appendChild(item);
        });
        resultsContainer.appendChild(section);
      }
      const matchedTags = tags.filter(tag => tag.name.toLowerCase().includes(query));
      if (matchedTags.length > 0) {
        const section = document.createElement('div');
        section.className = 'search-category';
        section.innerHTML = `<h4>Tags</h4>`;
        matchedTags.forEach(tag => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(tag.name);
          item.onclick = () => navigate('tags', `tag-${tag.id}`);
          section.appendChild(item);
        });
        resultsContainer.appendChild(section);
      }
      const matchedNotes = notes.filter(note =>
        (note.title && note.title.toLowerCase().includes(query)) ||
        (note.body && note.body.toLowerCase().includes(query))
      );
      if (matchedNotes.length > 0) {
        const section = document.createElement('div');
        section.className = 'search-category';
        section.innerHTML = `<h4>Notes</h4>`;
        matchedNotes.forEach(note => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(note.title || 'Untitled');
          item.onclick = () => navigate('notes', `note-${note.id}`);
          section.appendChild(item);
        });
        resultsContainer.appendChild(section);
      }
      const matchedTasks = tasks.filter(task => task.description.toLowerCase().includes(query));
      if (matchedTasks.length > 0) {
        const section = document.createElement('div');
        section.className = 'search-category';
        section.innerHTML = `<h4>Tasks</h4>`;
        matchedTasks.forEach(task => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(task.description);
          item.onclick = () => navigate('tasks', `task-${task.id}`);
          section.appendChild(item);
        });
        resultsContainer.appendChild(section);
      }
      const matchedHabits = habits.filter(habit => habit.description.toLowerCase().includes(query));
      if (matchedHabits.length > 0) {
        const section = document.createElement('div');
        section.className = 'search-category';
        section.innerHTML = `<h4>Habits</h4>`;
        matchedHabits.forEach(habit => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(habit.description);
          item.onclick = () => navigate('habits', `habit-${habit.id}`);
          section.appendChild(item);
        });
        resultsContainer.appendChild(section);
      }
      if (
        matchedNotebooks.length === 0 &&
        matchedTags.length === 0 &&
        matchedNotes.length === 0 &&
        matchedTasks.length === 0 &&
        matchedHabits.length === 0
      ) {
        resultsContainer.innerHTML = '<p>No results found.</p>';
      }
    }
    function openNotifications() {
      document.getElementById('notifications-modal').style.display = 'block';
      renderNotifications();
    }
    function closeNotifications() {
      document.getElementById('notifications-modal').style.display = 'none';
      renderNotifications();
    }
    function renderNotifications() {
      const notificationsList = document.getElementById('notifications-list');
      notificationsList.innerHTML = '';
      if (notifications.length === 0) {
        notificationsList.innerHTML = '<p>No notifications.</p>';
        return;
      }
      notifications.forEach(notif => {
        const notifDiv = document.createElement('div');
        notifDiv.className = 'notification-item';
        notifDiv.style.backgroundColor = notif.read ? '#f9f9f9' : '#e0f7fa';
        notifDiv.innerHTML = `
          <p>${notif.message}</p>
          <small>${notif.timestamp || ''}</small>
          <button onclick="markAsRead('${notif.id}')">${notif.read ? 'Mark as Unread' : 'Mark as Read'}</button>
        `;
        notificationsList.appendChild(notifDiv);
      });
    }
    function markAsRead(id) {
      const notif = notifications.find(n => n.id === id);
      if (notif) {
        notif.read = !notif.read;
        saveData();
        renderNotifications();
        updateNotificationBadge();
      }
    }
    function initializeNotifications() {
      updateNotificationBadge();
    }
    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      const unreadCount = notifications.filter(notif => !notif.read).length;
      badge.textContent = unreadCount;
      badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
    }
    function addNotification(message) {
      const notification = {
        id: generateUUID(),
        message,
        timestamp: new Date().toLocaleString(),
        read: false
      };
      notifications.unshift(notification);
      saveData();
      updateNotificationBadge();
    }
    function checkUpcomingEvents() {
      const today = new Date();
      tasks.forEach(task => {
        if (task.dueDate && !task.completed) {
          const dueDate = new Date(task.dueDate);
          const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
          if (diffDays >= 0 && diffDays <= 2) {
            addNotification(`Task "${task.description}" is due on ${task.dueDate}.`);
          }
        }
      });
      habits.forEach(habit => {
        if (habit.recurrence === 'daily') {
          addNotification(`Habit "${habit.description}" is scheduled today.`);
        } else if (habit.recurrence === 'custom' && habit.customDays.includes(today.toLocaleDateString(undefined, { weekday: 'long' }))) {
          addNotification(`Habit "${habit.description}" is scheduled today.`);
        }
      });
    }
    window.onclick = function(event) {
      const searchModal = document.getElementById('search-modal');
      if (event.target == searchModal) {
        searchModal.style.display = 'none';
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }
      const notificationsModal = document.getElementById('notifications-modal');
      if (event.target == notificationsModal) {
        notificationsModal.style.display = 'none';
        renderNotifications();
      }
      const editNotebookModal = document.getElementById('edit-notebook-modal');
      if (event.target == editNotebookModal) {
        editNotebookModal.style.display = 'none';
      }
      const editTagModal = document.getElementById('edit-tag-modal');
      if (event.target == editTagModal) {
        editTagModal.style.display = 'none';
      }
      const editNoteModal = document.getElementById('edit-note-modal');
      if (event.target == editNoteModal) {
        editNoteModal.style.display = 'none';
      }
      const editTaskModal = document.getElementById('edit-task-modal');
      if (event.target == editTaskModal) {
        editTaskModal.style.display = 'none';
      }
      const editHabitModal = document.getElementById('edit-habit-modal');
      if (event.target == editHabitModal) {
        editHabitModal.style.display = 'none';
      }
    };
    function showProfile() {
      showNotification('Profile feature not implemented.', 'error');
    }
  </script>
</body>
</html>
