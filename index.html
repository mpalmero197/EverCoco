<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NoteCoco</title>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Root Variables for Colors and Fonts */
    :root {
      --primary-color: #74acf2; /* Light Blue */
      --secondary-color: #ffffff; /* White */
      --accent-color: #0058a3; /* Dark Blue */
      --text-color: #333333;
      --background-color: #f0f8ff; /* Alice Blue for subtle background */
      --font-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Global Styles */
    body {
      margin: 0;
      font-family: var(--font-primary);
      background-color: var(--background-color);
      color: var(--text-color);
    }

    /* Header Styles */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--primary-color);
      color: var(--secondary-color);
      padding: 15px 30px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      cursor: default; /* Changed to default since it's no longer a toggle */
      font-size: 1.2rem;
      font-weight: bold;
    }

    .logo i {
      margin-right: 10px;
    }

    .header-right i {
      margin-left: 20px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: color 0.3s;
    }

    .header-right i:hover {
      color: var(--accent-color);
    }

    /* Sidebar Styles */
    aside.sidebar {
      position: fixed;
      top: 60px; /* Height of the header */
      left: 0;
      width: 220px;
      height: calc(100% - 60px);
      background-color: var(--secondary-color);
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      overflow-y: auto;
      padding-bottom: 20px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: var(--secondary-color);
      border-bottom: 1px solid #e0e0e0;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    /* Removed toggle button styles */
    /* 
    .sidebar-header .toggle-btn {
      background: none;
      border: none;
      color: var(--secondary-color);
      font-size: 1.2rem;
      cursor: pointer;
    }
    */

    .sidebar-menu .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #e0e0e0;
    }

    .sidebar-menu .menu-item:hover,
    .sidebar-menu .menu-item.active {
      background-color: #e6f0ff;
    }

    .sidebar-menu .menu-item i {
      margin-right: 12px;
      color: var(--accent-color);
      min-width: 20px;
      text-align: center;
    }

    /* Main Content Styles */
    main {
      margin-left: 220px; /* Width of the sidebar */
      padding: 80px 40px 40px 40px; /* Top padding accounts for fixed header */
      transition: margin-left 0.3s ease;
    }

    /* Removed full-width class styles */

    .kanban-board {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .kanban-column {
      background-color: var(--secondary-color);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 300px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
      overflow-y: auto;
    }

    .kanban-column h3 {
      margin-top: 0;
      display: flex;
      align-items: center;
      font-size: 1.3rem;
      color: var(--accent-color);
      margin-bottom: 15px;
    }

    .kanban-column h3 i {
      margin-right: 10px;
    }

    .cards-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .card {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: relative;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }

    .card:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }

    /* Adjusted Card Header to Prevent Overlapping */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .card-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-header-left i {
      font-size: 1rem;
      color: var(--accent-color);
    }

    .card-header .title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .card-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-header .favorite-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #ff9800;
      font-size: 1rem;
      transition: color 0.3s;
    }

    .card-header .favorite-btn:hover {
      color: #e68900;
    }

    .card-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: #555;
      font-size: 0.9rem;
      transition: color 0.3s;
    }

    .card-actions button:hover {
      color: var(--accent-color);
    }

    .details {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #444;
    }

    .attachments img {
      max-width: 100px;
      max-height: 100px;
      margin-right: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .attachments a {
      display: inline-block;
      margin-top: 8px;
      color: var(--primary-color);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .attachments a:hover {
      text-decoration: underline;
    }

    /* Form Elements */
    input[type="text"],
    textarea,
    select,
    input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.95rem;
    }

    textarea {
      resize: vertical;
    }

    label {
      font-weight: 500;
      color: var(--text-color);
    }

    .multi-select label {
      display: block;
      margin-top: 6px;
      font-weight: normal;
      color: #555;
    }

    .recurrence-options label {
      display: inline-block;
      margin-right: 15px;
      font-weight: normal;
      color: #555;
    }

    .custom-days {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
    }

    .custom-days label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: normal;
      color: #555;
    }

    /* Buttons */
    .btn {
      background-color: var(--primary-color);
      color: var(--secondary-color);
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.3s;
      align-self: flex-start;
    }

    .btn:hover {
      background-color: #659ad2;
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 80px;
      right: 30px;
      background-color: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .notification.show {
      opacity: 1;
    }

    .notification.success {
      background-color: #4CAF50;
    }

    .notification.error {
      background-color: #f44336;
    }

    /* Footer Styles */
    footer {
      text-align: center;
      padding: 15px;
      font-size: 0.85rem;
      color: #777;
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: var(--secondary-color);
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .kanban-board {
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      /* Sidebar remains fixed; adjust main padding if needed */
      main {
        padding: 80px 20px 60px 240px; /* Increased left padding for better visibility on small screens */
      }
      header {
        padding: 15px 20px;
      }
      .sidebar-header {
        /* Hidden since there's no toggle button */
        display: none;
      }
      .sidebar-menu .menu-item {
        padding: 12px 15px;
      }
    }

    /* Search Modal Styles */
    .search-modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1500; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    .search-modal-content {
      background-color: var(--secondary-color);
      margin: 10% auto; /* 10% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more or less, depending on screen size */
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    #search-input {
      width: 100%;
      padding: 12px 20px;
      margin: 12px 0 20px 0;
      box-sizing: border-box;
      border: 2px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }

    #search-results {
      max-height: 400px;
      overflow-y: auto;
    }

    .search-category {
      margin-bottom: 20px;
    }

    .search-category h4 {
      margin-bottom: 10px;
      color: var(--accent-color);
    }

    .search-item {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .search-item:hover {
      background-color: #f1f1f1;
    }

    .highlight {
      background-color: yellow;
    }
  </style>
</head>
<body>
  
  <!-- Header -->
  <header>
    <div class="logo">
      <i class="fas fa-feather-alt"></i>
      <span>NoteCoco</span>
    </div>
    <div class="header-right">
      <i class="fas fa-search" title="Search" onclick="openSearch()"></i>
      <i class="fas fa-bell" title="Notifications" onclick="showNotifications()"></i>
      <i class="fas fa-user-circle" title="Profile" onclick="showProfile()"></i>
    </div>
  </header>
  
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Menu</h2>
      <!-- Removed toggle button -->
      <!-- <button class="toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-angle-left"></i>
      </button> -->
    </div>
    <div class="sidebar-menu">
      <div class="menu-item active" onclick="navigate('dashboard')">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </div>
      <div class="menu-item" onclick="navigate('notebooks')">
        <i class="fas fa-book"></i>
        <span>Notebooks</span>
      </div>
      <div class="menu-item" onclick="navigate('tags')">
        <i class="fas fa-tags"></i>
        <span>Tags</span>
      </div>
      <div class="menu-item" onclick="navigate('notes')">
        <i class="fas fa-sticky-note"></i>
        <span>Notes</span>
      </div>
      <div class="menu-item" onclick="navigate('tasks')">
        <i class="fas fa-tasks"></i>
        <span>Tasks</span>
      </div>
      <div class="menu-item" onclick="navigate('habits')">
        <i class="fas fa-heartbeat"></i>
        <span>Habits</span>
      </div>
      <!-- Removed Favorites Menu Item -->
      <!--
      <div class="menu-item" onclick="navigate('favorites')">
        <i class="fas fa-star"></i>
        <span>Favorites</span>
      </div>
      -->
    </div>
  </aside>
  
  <!-- Main Content -->
  <main>
    <!-- Kanban Board -->
    <div class="kanban-board">
      
      <!-- Dashboard -->
      <section class="kanban-column" id="dashboard-section">
        <h3><i class="fas fa-tachometer-alt"></i> Dashboard</h3>
        <p>Welcome to NoteCoco! Manage your notes, tasks, and habits efficiently.</p>
        
        <!-- Favorites Section on Dashboard -->
        <div class="favorites-section">
          <h4><i class="fas fa-star"></i> Favorites</h4>
          
          <!-- Favorite Notebooks -->
          <div class="favorites-subsection" id="favorite-notebooks">
            <h5><i class="fas fa-book"></i> Notebooks</h5>
            <div class="favorites-list" id="favorites-dashboard-notebooks-list">
              <!-- Favorite Notebooks will be rendered here -->
            </div>
          </div>
          
          <!-- Favorite Tags -->
          <div class="favorites-subsection" id="favorite-tags">
            <h5><i class="fas fa-tags"></i> Tags</h5>
            <div class="favorites-list" id="favorites-dashboard-tags-list">
              <!-- Favorite Tags will be rendered here -->
            </div>
          </div>
          
          <!-- Favorite Notes -->
          <div class="favorites-subsection" id="favorite-notes">
            <h5><i class="fas fa-sticky-note"></i> Notes</h5>
            <div class="favorites-list" id="favorites-dashboard-notes-list">
              <!-- Favorite Notes will be rendered here -->
            </div>
          </div>
          
          <!-- Favorite Tasks -->
          <div class="favorites-subsection" id="favorite-tasks">
            <h5><i class="fas fa-tasks"></i> Tasks</h5>
            <div class="favorites-list" id="favorites-dashboard-tasks-list">
              <!-- Favorite Tasks will be rendered here -->
            </div>
          </div>
          
          <!-- Favorite Habits -->
          <div class="favorites-subsection" id="favorite-habits">
            <h5><i class="fas fa-heartbeat"></i> Habits</h5>
            <div class="favorites-list" id="favorites-dashboard-habits-list">
              <!-- Favorite Habits will be rendered here -->
            </div>
          </div>
        </div>
      </section>
      
      <!-- Notebooks -->
      <section class="kanban-column" id="notebooks-section" style="display: none;">
        <h3><i class="fas fa-book"></i> Notebooks</h3>
        <p>Create and organize your notebooks.</p>
        <input type="text" id="new-notebook-input" placeholder="Enter notebook name..." />
        <button class="btn" onclick="addNotebook()">Add Notebook</button>
        <div class="cards-list" id="notebooks-list">
          <!-- Notebooks will be rendered as cards here -->
        </div>
      </section>
      
      <!-- Tags -->
      <section class="kanban-column" id="tags-section" style="display: none;">
        <h3><i class="fas fa-tags"></i> Tags</h3>
        <p>Create and manage tags for better organization.</p>
        <input type="text" id="new-tag-input" placeholder="Enter tag name..." />
        <button class="btn" onclick="addTag()">Add Tag</button>
        <div class="cards-list" id="tags-list">
          <!-- Tags will be rendered as cards here -->
        </div>
      </section>
      
      <!-- Notes -->
      <section class="kanban-column" id="notes-section" style="display: none;">
        <h3><i class="fas fa-sticky-note"></i> Notes</h3>
        <p>Create and manage your notes.</p>
        <input type="text" id="note-title" placeholder="Note Title..." />
        <textarea id="note-body" rows="3" placeholder="Note Body..."></textarea>
        
        <label><strong>Tags:</strong></label>
        <div id="note-tags" class="multi-select"></div>
        <input type="text" id="note-new-tags" placeholder="Add new tags (comma separated)" />
        
        <label><strong>Notebook:</strong></label>
        <select id="note-notebook-select">
          <option value="">No Notebook</option>
        </select>
        
        <label><strong>Attachments:</strong></label>
        <input type="file" id="note-attachments" multiple accept="image/*,application/pdf,.doc,.docx,.txt" />
        <small>Max size: 2MB. Supported: Images, PDF, DOC, DOCX, TXT.</small>
        
        <button class="btn" onclick="addNote()">Add Note</button>
        <div class="cards-list" id="notes-list">
          <!-- Notes will be rendered as cards here -->
        </div>
      </section>
      
      <!-- Tasks -->
      <section class="kanban-column" id="tasks-section" style="display: none;">
        <h3><i class="fas fa-tasks"></i> Tasks</h3>
        <p>Create and manage your tasks with due dates and recurrence.</p>
        <input type="text" id="task-input" placeholder="Enter task description..." />
        <input type="date" id="task-due-date" />
        
        <label><strong>Recurrence:</strong></label>
        <div class="recurrence-options">
          <label><input type="radio" name="task-recurrence" value="none" checked onclick="toggleTaskCustomDays(false)"> None</label>
          <label><input type="radio" name="task-recurrence" value="daily" onclick="toggleTaskCustomDays(false)"> Daily</label>
          <label><input type="radio" name="task-recurrence" value="weekly" onclick="toggleTaskCustomDays(false)"> Weekly</label>
          <label><input type="radio" name="task-recurrence" value="monthly" onclick="toggleTaskCustomDays(false)"> Monthly</label>
          <label><input type="radio" name="task-recurrence" value="custom" onclick="toggleTaskCustomDays(true)"> Custom Days</label>
        </div>
        
        <div id="task-custom-days" class="custom-days" style="display: none;">
          <label><input type="checkbox" value="Monday"> M</label>
          <label><input type="checkbox" value="Tuesday"> T</label>
          <label><input type="checkbox" value="Wednesday"> W</label>
          <label><input type="checkbox" value="Thursday"> T</label>
          <label><input type="checkbox" value="Friday"> F</label>
          <label><input type="checkbox" value="Saturday"> S</label>
          <label><input type="checkbox" value="Sunday"> S</label>
        </div>
        
        <button class="btn" onclick="addTask()">Add Task</button>
        <div class="cards-list" id="tasks-list">
          <!-- Tasks will be rendered as cards here -->
        </div>
      </section>
      
      <!-- Habits -->
      <section class="kanban-column" id="habits-section" style="display: none;">
        <h3><i class="fas fa-heartbeat"></i> Habits</h3>
        <p>Create and track your habits.</p>
        <input type="text" id="habit-input" placeholder="Enter habit description..." />
        
        <label><strong>Recurrence:</strong></label>
        <div class="recurrence-options">
          <label><input type="radio" name="habit-recurrence" value="none" checked onclick="toggleHabitCustomDays(false)"> None</label>
          <label><input type="radio" name="habit-recurrence" value="daily" onclick="toggleHabitCustomDays(false)"> Daily</label>
          <label><input type="radio" name="habit-recurrence" value="weekly" onclick="toggleHabitCustomDays(false)"> Weekly</label>
          <label><input type="radio" name="habit-recurrence" value="monthly" onclick="toggleHabitCustomDays(false)"> Monthly</label>
          <label><input type="radio" name="habit-recurrence" value="custom" onclick="toggleHabitCustomDays(true)"> Custom Days</label>
        </div>
        
        <div id="habit-custom-days" class="custom-days" style="display: none;">
          <label><input type="checkbox" value="Monday"> M</label>
          <label><input type="checkbox" value="Tuesday"> T</label>
          <label><input type="checkbox" value="Wednesday"> W</label>
          <label><input type="checkbox" value="Thursday"> T</label>
          <label><input type="checkbox" value="Friday"> F</label>
          <label><input type="checkbox" value="Saturday"> S</label>
          <label><input type="checkbox" value="Sunday"> S</label>
        </div>
        
        <button class="btn" onclick="addHabit()">Add Habit</button>
        <div class="cards-list" id="habits-list">
          <!-- Habits will be rendered as cards here -->
        </div>
      </section>
      
      <!-- Removed Separate Favorites Section -->
      <!--
      <section class="kanban-column" id="favorites-section" style="display: none;">
        <h3><i class="fas fa-star"></i> Favorites</h3>
        <p>Here are your favorited items for quick access.</p>
        
        <div class="favorites-section">
          <!-- Favorite Notebooks -->
          <!-- <div class="favorites-subsection">
            <h4>Notebooks</h4>
            <div class="favorites-list" id="favorites-dashboard-notebooks-list">
              <!-- Favorite Notebooks will be rendered here -->
          <!-- </div>
          </div> -->
          
          <!-- Favorite Tags -->
          <!-- <div class="favorites-subsection">
            <h4>Tags</h4>
            <div class="favorites-list" id="favorites-dashboard-tags-list">
              <!-- Favorite Tags will be rendered here -->
          <!-- </div>
          </div> -->
          
          <!-- Favorite Notes -->
          <!-- <div class="favorites-subsection">
            <h4>Notes</h4>
            <div class="favorites-list" id="favorites-dashboard-notes-list">
              <!-- Favorite Notes will be rendered here -->
          <!-- </div>
          </div> -->
          
          <!-- Favorite Tasks -->
          <!-- <div class="favorites-subsection">
            <h4>Tasks</h4>
            <div class="favorites-list" id="favorites-dashboard-tasks-list">
              <!-- Favorite Tasks will be rendered here -->
          <!-- </div>
          </div> -->
          
          <!-- Favorite Habits -->
          <!-- <div class="favorites-subsection">
            <h4>Habits</h4>
            <div class="favorites-list" id="favorites-dashboard-habits-list">
              <!-- Favorite Habits will be rendered here -->
          <!-- </div>
          </div> -->
        <!-- </div>
      </section>
      -->
      
    </div>
  </main>
  
  <!-- Search Modal -->
  <div id="search-modal" class="search-modal">
    <div class="search-modal-content">
      <span class="close" onclick="closeSearch()">&times;</span>
      <h2>Search NoteCoco</h2>
      <input type="text" id="search-input" placeholder="Type to search..." oninput="performSearch()" />
      <div id="search-results">
        <!-- Search results will be dynamically inserted here -->
      </div>
    </div>
  </div>
  
  <!-- Notification -->
  <div class="notification" id="notification"></div>
  
  <!-- Footer -->
  <footer>
    &copy; 2024 NoteCoco. All rights reserved.
  </footer>
  
  <!-- JavaScript -->
  <script>
    // Helper Function to Retrieve CSS Variables
    function getCSSVariable(variableName) {
      return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
    }

    // Data Structures
    let notebooks = [];
    let tags = [];
    let notes = [];
    let tasks = [];
    let habits = [];

    // Initialize Application
    window.onload = function() {
      loadData();
      ensurePersonalNotebook();
      populateNotebookSelect();
      populateTagSelectors();
      renderAll();
      resetStreaks();
    };

    // Load Data from localStorage
    function loadData() {
      notebooks = JSON.parse(localStorage.getItem('notecoco_notebooks')) || [];
      tags = JSON.parse(localStorage.getItem('notecoco_tags')) || [];
      notes = JSON.parse(localStorage.getItem('notecoco_notes')) || [];
      tasks = JSON.parse(localStorage.getItem('notecoco_tasks')) || [];
      habits = JSON.parse(localStorage.getItem('notecoco_habits')) || [];

      // Ensure tags are objects with 'name' and 'favorite'
      tags = tags.map(tag => {
        if (typeof tag === 'string') {
          return { name: tag, favorite: false };
        }
        return tag;
      });

      // Initialize 'favorite' if undefined
      notebooks.forEach(nb => { if (nb.favorite === undefined) nb.favorite = false; });
      tags.forEach(tag => { if (tag.favorite === undefined) tag.favorite = false; });
      notes.forEach(note => { if (note.favorite === undefined) note.favorite = false; });
      tasks.forEach(task => { if (task.favorite === undefined) task.favorite = false; });
      habits.forEach(habit => { if (habit.favorite === undefined) habit.favorite = false; });
    }

    // Save Data to localStorage
    function saveData() {
      localStorage.setItem('notecoco_notebooks', JSON.stringify(notebooks));
      localStorage.setItem('notecoco_tags', JSON.stringify(tags));
      localStorage.setItem('notecoco_notes', JSON.stringify(notes));
      localStorage.setItem('notecoco_tasks', JSON.stringify(tasks));
      localStorage.setItem('notecoco_habits', JSON.stringify(habits));
    }

    // Ensure "Personal" Notebook Exists
    function ensurePersonalNotebook() {
      const personalExists = notebooks.some(nb => nb.name.toLowerCase() === 'personal');
      if (!personalExists) {
        notebooks.push({ id: Date.now(), name: 'Personal', favorite: false });
        saveData();
      }
    }

    // Populate Notebook Selectors
    function populateNotebookSelect() {
      const notebookSelects = document.querySelectorAll('#note-notebook-select');
      notebookSelects.forEach(select => {
        select.innerHTML = '<option value="">No Notebook</option>';
        notebooks.forEach(nb => {
          const option = document.createElement('option');
          option.value = nb.name;
          option.textContent = nb.name;
          select.appendChild(option);
        });
      });
    }

    // Populate Tag Selectors
    function populateTagSelectors() {
      const tagContainers = document.querySelectorAll('.multi-select');
      tagContainers.forEach(container => {
        container.innerHTML = '';
        tags.forEach(tag => {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = tag.name;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(tag.name));
          container.appendChild(label);
        });
      });
    }

    // Render All Sections
    function renderAll() {
      renderNotebooks();
      renderTags();
      renderNotes();
      renderTasks();
      renderHabits();
      renderDashboardFavorites();
      renderSidebar();
    }

    // Render Functions for Each Section
    function renderNotebooks() {
      const notebooksList = document.getElementById('notebooks-list');
      notebooksList.innerHTML = '';
      notebooks.forEach(nb => {
        const card = createCard(nb.name, 'notebooks', nb.id, 'book', nb.favorite, () => toggleFavorite('notebooks', nb.id));
        card.id = `notebook-${nb.id}`; // Assign unique ID to the card
        
        // Actions for non-Personal notebooks
        if (nb.name.toLowerCase() !== 'personal') {
          const actions = createCardActions([
            { icon: 'edit', title: 'Rename', action: () => renameNotebook(nb.id) },
            { icon: 'trash', title: 'Delete', action: () => deleteNotebook(nb.id) }
          ]);
          card.querySelector('.card-header-right').appendChild(actions);
        }

        card.ondblclick = () => {
          if (nb.name.toLowerCase() !== 'personal') {
            renameNotebook(nb.id);
          } else {
            showNotification('The "Personal" notebook cannot be renamed.', 'error');
          }
        };

        notebooksList.appendChild(card);
      });
    }

    function renderTags() {
      const tagsList = document.getElementById('tags-list');
      tagsList.innerHTML = '';
      tags.forEach(tag => {
        const card = createCard(tag.name, 'tags', tag.name, 'tags', tag.favorite, () => toggleFavorite('tags', tag.name));
        card.id = `tag-${tag.name}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: 'edit', title: 'Rename', action: () => renameTag(tag.name) },
          { icon: 'trash', title: 'Delete', action: () => deleteTag(tag.name) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        card.ondblclick = () => {
          renameTag(tag.name);
        };

        tagsList.appendChild(card);
      });
    }

    function renderNotes() {
      const notesList = document.getElementById('notes-list');
      notesList.innerHTML = '';
      notes.forEach(note => {
        const card = createCard(note.title || 'Untitled', 'notes', note.id, 'sticky-note', note.favorite, () => toggleFavorite('notes', note.id));
        card.id = `note-${note.id}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: 'edit', title: 'Edit', action: () => editNote(note.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteNote(note.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        // Details
        if (note.body) {
          const body = document.createElement('div');
          body.className = 'details';
          body.textContent = note.body;
          card.appendChild(body);
        }

        if (note.tags.length > 0) {
          const tagDiv = document.createElement('div');
          tagDiv.className = 'details';
          tagDiv.textContent = 'Tags: ' + note.tags.join(', ');
          card.appendChild(tagDiv);
        }

        if (note.notebook) {
          const nbDiv = document.createElement('div');
          nbDiv.className = 'details';
          nbDiv.textContent = 'Notebook: ' + note.notebook;
          card.appendChild(nbDiv);
        }

        if (note.attachments.length > 0) {
          const attachDiv = document.createElement('div');
          attachDiv.className = 'attachments';
          note.attachments.forEach(att => {
            if (att.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = att.data;
              img.alt = att.name;
              attachDiv.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = att.data;
              link.download = att.name;
              link.textContent = att.name;
              attachDiv.appendChild(link);
            }
          });
          card.appendChild(attachDiv);
        }

        card.ondblclick = () => {
          editNote(note.id);
        };

        notesList.appendChild(card);
      });
    }

    function renderTasks() {
      const tasksList = document.getElementById('tasks-list');
      tasksList.innerHTML = '';
      tasks.forEach(task => {
        const card = createCard(task.description, 'tasks', task.id, 'tasks', task.favorite, () => toggleFavorite('tasks', task.id));
        card.id = `task-${task.id}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: task.completed ? 'undo' : 'check', title: task.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleTaskCompletion(task.id) },
          { icon: 'edit', title: 'Edit', action: () => editTask(task.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteTask(task.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        // Details
        if (task.dueDate) {
          const dueDate = document.createElement('div');
          dueDate.className = 'details';
          dueDate.textContent = 'Due: ' + task.dueDate;
          card.appendChild(dueDate);
        }

        if (task.recurrence !== 'none') {
          const recurrence = document.createElement('div');
          recurrence.className = 'details';
          recurrence.textContent = 'Recurs: ' + formatRecurrence(task);
          card.appendChild(recurrence);
        }

        card.ondblclick = () => {
          editTask(task.id);
        };

        tasksList.appendChild(card);
      });
    }

    function renderHabits() {
      const habitsList = document.getElementById('habits-list');
      habitsList.innerHTML = '';
      habits.forEach(habit => {
        const card = createCard(habit.description, 'habits', habit.id, 'heartbeat', habit.favorite, () => toggleFavorite('habits', habit.id));
        card.id = `habit-${habit.id}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: habit.completed ? 'undo' : 'check', title: habit.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleHabitCompletion(habit.id) },
          { icon: 'edit', title: 'Edit', action: () => editHabit(habit.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteHabit(habit.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        // Details
        if (habit.recurrence !== 'none') {
          const recurDiv = document.createElement('div');
          recurDiv.className = 'details';
          recurDiv.textContent = 'Recurs: ' + formatRecurrence(habit);
          card.appendChild(recurDiv);
        }

        card.ondblclick = () => {
          editHabit(habit.id);
        };

        habitsList.appendChild(card);
      });
    }

    // Helper Function to Create Cards
    function createCard(title, type, identifier, icon, favorite, favoriteAction) {
      const card = document.createElement('div');
      card.className = 'card';
      
      const header = document.createElement('div');
      header.className = 'card-header';
      
      const headerLeft = document.createElement('div');
      headerLeft.className = 'card-header-left';
      
      if (icon) {
        const iconElem = document.createElement('i');
        iconElem.className = `fas fa-${icon}`;
        headerLeft.appendChild(iconElem);
      }
      
      const titleSpan = document.createElement('span');
      titleSpan.className = 'title';
      titleSpan.textContent = title;
      headerLeft.appendChild(titleSpan);
      
      header.appendChild(headerLeft);
      
      const headerRight = document.createElement('div');
      headerRight.className = 'card-header-right';
      
      const favoriteBtn = document.createElement('button');
      favoriteBtn.className = 'favorite-btn';
      favoriteBtn.title = favorite ? 'Unfavorite' : 'Favorite';
      favoriteBtn.innerHTML = favorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
      favoriteBtn.onclick = (e) => {
        e.stopPropagation();
        favoriteAction();
      };
      headerRight.appendChild(favoriteBtn);
      
      // Card actions will be appended by the caller
      header.appendChild(headerRight);
      
      card.appendChild(header);
      
      return card;
    }

    // Helper Function to Create Card Actions
    function createCardActions(actionsArray) {
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'card-actions';
      
      actionsArray.forEach(actionObj => {
        const btn = document.createElement('button');
        btn.title = actionObj.title;
        btn.innerHTML = `<i class="fas fa-${actionObj.icon}"></i>`;
        btn.onclick = (e) => {
          e.stopPropagation();
          actionObj.action();
        };
        actionsDiv.appendChild(btn);
      });
      
      return actionsDiv;
    }

    // Helper Function to Format Recurrence Text
    function formatRecurrence(item) {
      if (item.recurrence === 'daily') return 'Daily';
      if (item.recurrence === 'weekly') return 'Weekly';
      if (item.recurrence === 'monthly') return 'Monthly';
      if (item.recurrence === 'custom') return 'Custom Days (' + item.customDays.join(', ') + ')';
      return 'None';
    }

    // Add Notebook
    function addNotebook() {
      const input = document.getElementById('new-notebook-input');
      const name = input.value.trim();
      if (!name) {
        showNotification('Notebook name cannot be empty.', 'error');
        return;
      }
      if (notebooks.some(nb => nb.name.toLowerCase() === name.toLowerCase())) {
        showNotification('Notebook with this name already exists.', 'error');
        return;
      }
      notebooks.push({ id: Date.now(), name, favorite: false });
      input.value = '';
      saveData();
      populateNotebookSelect();
      renderNotebooks();
      renderDashboardFavorites();
      showNotification('Notebook added successfully.', 'success');
    }

    // Delete Notebook
    function deleteNotebook(id) {
      const notebook = notebooks.find(nb => nb.id === id);
      if (!notebook) return;
      if (notebook.name.toLowerCase() === 'personal') {
        showNotification('The "Personal" notebook cannot be deleted.', 'error');
        return;
      }
      if (confirm(`Are you sure you want to delete the notebook "${notebook.name}"?`)) {
        notebooks = notebooks.filter(nb => nb.id !== id);
        // Unassign notebook from notes
        notes = notes.map(note => {
          if (note.notebook === notebook.name) {
            return { ...note, notebook: '', favorite: note.favorite };
          }
          return note;
        });
        saveData();
        populateNotebookSelect();
        renderNotebooks();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Notebook deleted successfully.', 'success');
      }
    }

    // Rename Notebook
    function renameNotebook(id) {
      const notebook = notebooks.find(nb => nb.id === id);
      if (!notebook) return;
      const newName = prompt('Enter new notebook name:', notebook.name);
      if (newName && newName.trim()) {
        const trimmedName = newName.trim();
        if (notebooks.some(nb => nb.name.toLowerCase() === trimmedName.toLowerCase())) {
          showNotification('A notebook with this name already exists.', 'error');
          return;
        }
        // Update notebook name in notes
        notes = notes.map(note => {
          if (note.notebook === notebook.name) {
            return { ...note, notebook: trimmedName };
          }
          return note;
        });
        notebook.name = trimmedName;
        saveData();
        populateNotebookSelect();
        renderNotebooks();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Notebook renamed successfully.', 'success');
      }
    }

    // Add Tag
    function addTag() {
      const input = document.getElementById('new-tag-input');
      const name = input.value.trim();
      if (!name) {
        showNotification('Tag name cannot be empty.', 'error');
        return;
      }
      if (tags.some(tag => tag.name.toLowerCase() === name.toLowerCase())) {
        showNotification('Tag already exists.', 'error');
        return;
      }
      tags.push({ name, favorite: false });
      input.value = '';
      saveData();
      populateTagSelectors();
      renderTags();
      renderDashboardFavorites();
      showNotification('Tag added successfully.', 'success');
    }

    // Delete Tag
    function deleteTag(tagName) {
      if (confirm(`Are you sure you want to delete the tag "${tagName}"? This will remove it from all notes.`)) {
        tags = tags.filter(tag => tag.name !== tagName);
        // Remove tag from notes
        notes = notes.map(note => {
          if (note.tags.includes(tagName)) {
            return { ...note, tags: note.tags.filter(t => t !== tagName) };
          }
          return note;
        });
        saveData();
        populateTagSelectors();
        renderTags();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Tag deleted successfully.', 'success');
      }
    }

    // Rename Tag
    function renameTag(oldName) {
      const tag = tags.find(t => t.name === oldName);
      if (!tag) return;
      const newName = prompt('Enter new tag name:', tag.name);
      if (newName && newName.trim()) {
        const trimmedName = newName.trim();
        if (tags.some(t => t.name.toLowerCase() === trimmedName.toLowerCase())) {
          showNotification('A tag with this name already exists.', 'error');
          return;
        }
        // Update tag name in notes
        notes = notes.map(note => {
          if (note.tags.includes(oldName)) {
            return { ...note, tags: note.tags.map(t => t === oldName ? trimmedName : t) };
          }
          return note;
        });
        tag.name = trimmedName;
        saveData();
        populateTagSelectors();
        renderTags();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Tag renamed successfully.', 'success');
      }
    }

    // Add Note
    function addNote() {
      const titleInput = document.getElementById('note-title');
      const bodyInput = document.getElementById('note-body');
      const tagsContainer = document.getElementById('note-tags');
      const newTagsInput = document.getElementById('note-new-tags');
      const notebookSelect = document.getElementById('note-notebook-select');
      const attachmentsInput = document.getElementById('note-attachments');

      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();
      const selectedTags = Array.from(tagsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const newTags = newTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      const notebook = notebookSelect.value;

      let allNoteTags = [...selectedTags, ...newTags];
      allNoteTags = [...new Set(allNoteTags)]; // Remove duplicates

      // Add new tags to tags list
      newTags.forEach(tag => {
        if (!tags.some(t => t.name.toLowerCase() === tag.toLowerCase())) {
          tags.push({ name: tag, favorite: false });
        }
      });

      const attachments = [];
      const files = attachmentsInput.files;
      const validFileTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
      
      if (files.length > 0) {
        let filesProcessed = 0;
        for (let file of files) {
          if (file.size > 2 * 1024 * 1024) {
            showNotification(`File "${file.name}" exceeds the 2MB limit and was not added.`, 'error');
            filesProcessed++;
            if (filesProcessed === files.length) finalizeAddNote();
            continue;
          }
          if (!validFileTypes.includes(file.type)) {
            showNotification(`File type of "${file.name}" is not supported and was not added.`, 'error');
            filesProcessed++;
            if (filesProcessed === files.length) finalizeAddNote();
            continue;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            attachments.push({
              name: file.name,
              type: file.type,
              data: e.target.result
            });
            filesProcessed++;
            if (filesProcessed === files.length) finalizeAddNote();
          };
          reader.readAsDataURL(file);
        }
      } else {
        finalizeAddNote();
      }

      function finalizeAddNote() {
        const note = {
          id: Date.now(),
          title,
          body,
          tags: allNoteTags,
          notebook,
          attachments,
          favorite: false
        };
        notes.push(note);
        saveData();
        populateTagSelectors();
        renderTags();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Note added successfully.', 'success');
        clearNoteForm();
      }

      function clearNoteForm() {
        titleInput.value = '';
        bodyInput.value = '';
        newTagsInput.value = '';
        tagsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        notebookSelect.value = '';
        attachmentsInput.value = '';
      }
    }

    // Edit Note
    function editNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;

      // Create a modal or use prompts for editing
      // For simplicity, using prompts here
      const newTitle = prompt('Edit Note Title:', note.title);
      if (newTitle === null) return; // Cancelled
      const updatedTitle = newTitle.trim() || 'Untitled';

      const newBody = prompt('Edit Note Body:', note.body);
      if (newBody === null) return; // Cancelled
      const updatedBody = newBody.trim();

      const updatedTags = prompt('Edit Tags (comma separated):', note.tags.join(', '));
      if (updatedTags === null) return; // Cancelled
      const tagsArray = updatedTags.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
      note.tags = [...new Set(tagsArray)];

      const updatedNotebook = prompt('Edit Notebook:', note.notebook);
      if (updatedNotebook === null) return; // Cancelled
      note.notebook = updatedNotebook.trim();

      saveData();
      populateTagSelectors();
      renderTags();
      renderNotes();
      renderDashboardFavorites();
      showNotification('Note updated successfully.', 'success');
    }

    // Delete Note
    function deleteNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      if (confirm('Are you sure you want to delete this note?')) {
        notes = notes.filter(n => n.id !== id);
        saveData();
        renderNotes();
        renderDashboardFavorites();
        showNotification('Note deleted successfully.', 'success');
      }
    }

    // Add Task
    function addTask() {
      const descInput = document.getElementById('task-input');
      const dueDateInput = document.getElementById('task-due-date');
      const recurrenceRadios = document.getElementsByName('task-recurrence');
      const customDaysDiv = document.getElementById('task-custom-days');

      const description = descInput.value.trim();
      const dueDate = dueDateInput.value;
      let recurrence = 'none';
      recurrenceRadios.forEach(radio => {
        if (radio.checked) recurrence = radio.value;
      });

      let customDays = [];
      if (recurrence === 'custom') {
        const checkboxes = customDaysDiv.querySelectorAll('input[type="checkbox"]:checked');
        customDays = Array.from(checkboxes).map(cb => cb.value);
        if (customDays.length === 0) {
          showNotification('Please select at least one day for custom recurrence.', 'error');
          return;
        }
      }

      if (!description) {
        showNotification('Task description cannot be empty.', 'error');
        return;
      }

      const task = {
        id: Date.now(),
        description,
        dueDate,
        recurrence,
        customDays,
        completed: false,
        streak: 0,
        lastCompleted: null,
        favorite: false
      };

      tasks.push(task);
      saveData();
      renderTasks();
      renderDashboardFavorites();
      showNotification('Task added successfully.', 'success');
      clearTaskForm();
    }

    // Clear Task Form
    function clearTaskForm() {
      document.getElementById('task-input').value = '';
      document.getElementById('task-due-date').value = '';
      document.querySelectorAll('input[name="task-recurrence"]').forEach(radio => radio.checked = false);
      document.querySelector('input[name="task-recurrence"][value="none"]').checked = true;
      toggleTaskCustomDays(false);
    }

    // Toggle Task Custom Days
    function toggleTaskCustomDays(show) {
      const customDaysDiv = document.getElementById('task-custom-days');
      if (show) {
        customDaysDiv.style.display = 'flex';
      } else {
        customDaysDiv.style.display = 'none';
        customDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    }

    // Toggle Task Completion
    function toggleTaskCompletion(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.completed = !task.completed;
      if (task.completed) {
        task.lastCompleted = new Date().toDateString();
        task.streak += 1;
        showNotification('Task marked as completed!', 'success');
      } else {
        task.lastCompleted = null;
        if (task.streak > 0) task.streak -= 1;
        showNotification('Task marked as incomplete.', 'success');
      }
      saveData();
      renderTasks();
      renderDashboardFavorites();
    }

    // Edit Task
    function editTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;

      const newDesc = prompt('Edit Task Description:', task.description);
      if (newDesc === null) return; // Cancelled
      const updatedDesc = newDesc.trim() || task.description;

      const newDueDate = prompt('Edit Due Date (YYYY-MM-DD):', task.dueDate);
      if (newDueDate === null) return; // Cancelled
      const updatedDueDate = newDueDate.trim();

      let updatedRecurrence = prompt('Edit Recurrence (none, daily, weekly, monthly, custom):', task.recurrence);
      if (updatedRecurrence === null) return; // Cancelled
      updatedRecurrence = updatedRecurrence.trim().toLowerCase();

      let updatedCustomDays = [];
      if (updatedRecurrence === 'custom') {
        const days = prompt('Enter custom days separated by commas (e.g., Monday, Wednesday):', task.customDays.join(', '));
        if (days === null) return; // Cancelled
        updatedCustomDays = days.split(',').map(day => day.trim()).filter(day => day !== '');
        if (updatedCustomDays.length === 0) {
          showNotification('Please enter at least one day for custom recurrence.', 'error');
          return;
        }
      }

      task.description = updatedDesc;
      task.dueDate = updatedDueDate;
      task.recurrence = updatedRecurrence;
      task.customDays = updatedRecurrence === 'custom' ? updatedCustomDays : [];

      saveData();
      renderTasks();
      renderDashboardFavorites();
      showNotification('Task updated successfully.', 'success');
    }

    // Delete Task
    function deleteTask(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      if (confirm('Are you sure you want to delete this task?')) {
        tasks = tasks.filter(t => t.id !== id);
        saveData();
        renderTasks();
        renderDashboardFavorites();
        showNotification('Task deleted successfully.', 'success');
      }
    }

    // Add Habit
    function addHabit() {
      const descInput = document.getElementById('habit-input');
      const recurrenceRadios = document.getElementsByName('habit-recurrence');
      const customDaysDiv = document.getElementById('habit-custom-days');

      const description = descInput.value.trim();
      if (!description) {
        showNotification('Habit description cannot be empty.', 'error');
        return;
      }

      let recurrence = 'none';
      recurrenceRadios.forEach(radio => {
        if (radio.checked) recurrence = radio.value;
      });

      let customDays = [];
      if (recurrence === 'custom') {
        const checkboxes = customDaysDiv.querySelectorAll('input[type="checkbox"]:checked');
        customDays = Array.from(checkboxes).map(cb => cb.value);
        if (customDays.length === 0) {
          showNotification('Please select at least one day for custom recurrence.', 'error');
          return;
        }
      }

      const habit = {
        id: Date.now(),
        description,
        recurrence,
        customDays,
        completed: false,
        streak: 0,
        lastCompleted: null,
        favorite: false
      };

      habits.push(habit);
      saveData();
      renderHabits();
      renderDashboardFavorites();
      showNotification('Habit added successfully.', 'success');
      clearHabitForm();
    }

    // Clear Habit Form
    function clearHabitForm() {
      document.getElementById('habit-input').value = '';
      document.querySelectorAll('input[name="habit-recurrence"]').forEach(radio => radio.checked = false);
      document.querySelector('input[name="habit-recurrence"][value="none"]').checked = true;
      toggleHabitCustomDays(false);
    }

    // Toggle Habit Custom Days
    function toggleHabitCustomDays(show) {
      const customDaysDiv = document.getElementById('habit-custom-days');
      if (show) {
        customDaysDiv.style.display = 'flex';
      } else {
        customDaysDiv.style.display = 'none';
        customDaysDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      }
    }

    // Toggle Habit Completion
    function toggleHabitCompletion(id) {
      const habit = habits.find(h => h.id === id);
      if (!habit) return;
      habit.completed = !habit.completed;
      if (habit.completed) {
        habit.lastCompleted = new Date().toDateString();
        habit.streak += 1;
        showNotification('Habit marked as completed!', 'success');
      } else {
        habit.lastCompleted = null;
        if (habit.streak > 0) habit.streak -= 1;
        showNotification('Habit marked as incomplete.', 'success');
      }
      saveData();
      renderHabits();
      renderDashboardFavorites();
    }

    // Edit Habit
    function editHabit(id) {
      const habit = habits.find(h => h.id === id);
      if (!habit) return;

      const newDesc = prompt('Edit Habit Description:', habit.description);
      if (newDesc === null) return; // Cancelled
      const updatedDesc = newDesc.trim() || habit.description;

      const newRecurrence = prompt('Edit Recurrence (none, daily, weekly, monthly, custom):', habit.recurrence);
      if (newRecurrence === null) return; // Cancelled
      const updatedRecurrence = newRecurrence.trim().toLowerCase();

      let updatedCustomDays = [];
      if (updatedRecurrence === 'custom') {
        const days = prompt('Enter custom days separated by commas (e.g., Monday, Wednesday):', habit.customDays.join(', '));
        if (days === null) return; // Cancelled
        updatedCustomDays = days.split(',').map(day => day.trim()).filter(day => day !== '');
        if (updatedCustomDays.length === 0) {
          showNotification('Please enter at least one day for custom recurrence.', 'error');
          return;
        }
      }

      habit.description = updatedDesc;
      habit.recurrence = updatedRecurrence;
      habit.customDays = updatedRecurrence === 'custom' ? updatedCustomDays : [];

      saveData();
      renderHabits();
      renderDashboardFavorites();
      showNotification('Habit updated successfully.', 'success');
    }

    // Delete Habit
    function deleteHabit(id) {
      const habit = habits.find(h => h.id === id);
      if (!habit) return;
      if (confirm('Are you sure you want to delete this habit?')) {
        habits = habits.filter(h => h.id !== id);
        saveData();
        renderHabits();
        renderDashboardFavorites();
        showNotification('Habit deleted successfully.', 'success');
      }
    }

    // Toggle Favorite
    function toggleFavorite(type, identifier) {
      switch(type) {
        case 'notebooks':
          const notebook = notebooks.find(nb => nb.id === identifier);
          if (notebook) {
            notebook.favorite = !notebook.favorite;
          }
          break;
        case 'tags':
          const tag = tags.find(t => t.name === identifier);
          if (tag) {
            tag.favorite = !tag.favorite;
          }
          break;
        case 'notes':
          const note = notes.find(n => n.id === identifier);
          if (note) {
            note.favorite = !note.favorite;
          }
          break;
        case 'tasks':
          const task = tasks.find(t => t.id === identifier);
          if (task) {
            task.favorite = !task.favorite;
          }
          break;
        case 'habits':
          const habit = habits.find(h => h.id === identifier);
          if (habit) {
            habit.favorite = !habit.favorite;
          }
          break;
        default:
          break;
      }
      saveData();
      renderAll();
      showNotification('Favorite status updated.', 'success');
    }

    // Render Dashboard Favorites
    function renderDashboardFavorites() {
      renderFavoriteNotebooks();
      renderFavoriteTags();
      renderFavoriteNotes();
      renderFavoriteTasks();
      renderFavoriteHabits();
    }

    function renderFavoriteNotebooks() {
      const favNotebooksList = document.getElementById('favorites-dashboard-notebooks-list');
      favNotebooksList.innerHTML = '';
      const favoriteNotebooks = notebooks.filter(nb => nb.favorite);
      
      if (favoriteNotebooks.length === 0) {
        favNotebooksList.innerHTML = '<p>No favorite notebooks.</p>';
        return;
      }

      favoriteNotebooks.forEach(nb => {
        const card = createCard(nb.name, 'notebooks', nb.id, 'book', nb.favorite, () => toggleFavorite('notebooks', nb.id));
        card.id = `notebook-${nb.id}`; // Assign unique ID to the card
        
        // Actions for non-Personal notebooks
        if (nb.name.toLowerCase() !== 'personal') {
          const actions = createCardActions([
            { icon: 'edit', title: 'Rename', action: () => renameNotebook(nb.id) },
            { icon: 'trash', title: 'Delete', action: () => deleteNotebook(nb.id) }
          ]);
          card.querySelector('.card-header-right').appendChild(actions);
        }

        card.ondblclick = () => {
          if (nb.name.toLowerCase() !== 'personal') {
            renameNotebook(nb.id);
          } else {
            showNotification('The "Personal" notebook cannot be renamed.', 'error');
          }
        };

        favNotebooksList.appendChild(card);
      });
    }

    function renderFavoriteTags() {
      const favTagsList = document.getElementById('favorites-dashboard-tags-list');
      favTagsList.innerHTML = '';
      const favoriteTags = tags.filter(tag => tag.favorite);
      
      if (favoriteTags.length === 0) {
        favTagsList.innerHTML = '<p>No favorite tags.</p>';
        return;
      }

      favoriteTags.forEach(tag => {
        const card = createCard(tag.name, 'tags', tag.name, 'tags', tag.favorite, () => toggleFavorite('tags', tag.name));
        card.id = `tag-${tag.name}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: 'edit', title: 'Rename', action: () => renameTag(tag.name) },
          { icon: 'trash', title: 'Delete', action: () => deleteTag(tag.name) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        card.ondblclick = () => {
          renameTag(tag.name);
        };

        favTagsList.appendChild(card);
      });
    }

    function renderFavoriteNotes() {
      const favNotesList = document.getElementById('favorites-dashboard-notes-list');
      favNotesList.innerHTML = '';
      const favoriteNotes = notes.filter(note => note.favorite);
      
      if (favoriteNotes.length === 0) {
        favNotesList.innerHTML = '<p>No favorite notes.</p>';
        return;
      }

      favoriteNotes.forEach(note => {
        const card = createCard(note.title || 'Untitled', 'notes', note.id, 'sticky-note', note.favorite, () => toggleFavorite('notes', note.id));
        card.id = `note-${note.id}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: 'edit', title: 'Edit', action: () => editNote(note.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteNote(note.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        // Details
        if (note.body) {
          const body = document.createElement('div');
          body.className = 'details';
          body.textContent = note.body;
          card.appendChild(body);
        }

        if (note.tags.length > 0) {
          const tagDiv = document.createElement('div');
          tagDiv.className = 'details';
          tagDiv.textContent = 'Tags: ' + note.tags.join(', ');
          card.appendChild(tagDiv);
        }

        if (note.notebook) {
          const nbDiv = document.createElement('div');
          nbDiv.className = 'details';
          nbDiv.textContent = 'Notebook: ' + note.notebook;
          card.appendChild(nbDiv);
        }

        if (note.attachments.length > 0) {
          const attachDiv = document.createElement('div');
          attachDiv.className = 'attachments';
          note.attachments.forEach(att => {
            if (att.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = att.data;
              img.alt = att.name;
              attachDiv.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = att.data;
              link.download = att.name;
              link.textContent = att.name;
              attachDiv.appendChild(link);
            }
          });
          card.appendChild(attachDiv);
        }

        card.ondblclick = () => {
          editNote(note.id);
        };

        favNotesList.appendChild(card);
      });
    }

    function renderFavoriteTasks() {
      const favTasksList = document.getElementById('favorites-dashboard-tasks-list');
      favTasksList.innerHTML = '';
      const favoriteTasks = tasks.filter(task => task.favorite);
      
      if (favoriteTasks.length === 0) {
        favTasksList.innerHTML = '<p>No favorite tasks.</p>';
        return;
      }

      favoriteTasks.forEach(task => {
        const card = createCard(task.description, 'tasks', task.id, 'tasks', task.favorite, () => toggleFavorite('tasks', task.id));
        card.id = `task-${task.id}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: task.completed ? 'undo' : 'check', title: task.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleTaskCompletion(task.id) },
          { icon: 'edit', title: 'Edit', action: () => editTask(task.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteTask(task.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        // Details
        if (task.dueDate) {
          const dueDate = document.createElement('div');
          dueDate.className = 'details';
          dueDate.textContent = 'Due: ' + task.dueDate;
          card.appendChild(dueDate);
        }

        if (task.recurrence !== 'none') {
          const recurrence = document.createElement('div');
          recurrence.className = 'details';
          recurrence.textContent = 'Recurs: ' + formatRecurrence(task);
          card.appendChild(recurrence);
        }

        card.ondblclick = () => {
          editTask(task.id);
        };

        favTasksList.appendChild(card);
      });
    }

    function renderFavoriteHabits() {
      const favHabitsList = document.getElementById('favorites-dashboard-habits-list');
      favHabitsList.innerHTML = '';
      const favoriteHabits = habits.filter(habit => habit.favorite);
      
      if (favoriteHabits.length === 0) {
        favHabitsList.innerHTML = '<p>No favorite habits.</p>';
        return;
      }

      favoriteHabits.forEach(habit => {
        const card = createCard(habit.description, 'habits', habit.id, 'heartbeat', habit.favorite, () => toggleFavorite('habits', habit.id));
        card.id = `habit-${habit.id}`; // Assign unique ID to the card

        const actions = createCardActions([
          { icon: habit.completed ? 'undo' : 'check', title: habit.completed ? 'Mark as Incomplete' : 'Mark as Complete', action: () => toggleHabitCompletion(habit.id) },
          { icon: 'edit', title: 'Edit', action: () => editHabit(habit.id) },
          { icon: 'trash', title: 'Delete', action: () => deleteHabit(habit.id) }
        ]);
        card.querySelector('.card-header-right').appendChild(actions);

        // Details
        if (habit.recurrence !== 'none') {
          const recurDiv = document.createElement('div');
          recurDiv.className = 'details';
          recurDiv.textContent = 'Recurs: ' + formatRecurrence(habit);
          card.appendChild(recurDiv);
        }

        card.ondblclick = () => {
          editHabit(habit.id);
        };

        favHabitsList.appendChild(card);
      });
    }

    // Render Sidebar (Summary)
    function renderSidebar() {
      // Placeholder for additional sidebar summaries if needed
    }

    // Show Notification
    function showNotification(message, type) {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.className = 'notification ' + (type === 'error' ? 'error' : 'success');
      notif.classList.add('show');
      setTimeout(() => {
        notif.classList.remove('show');
      }, 3000);
    }

    // Navigate between sections and optionally scroll to an item
    function navigate(section, itemId = null) {
      const sections = document.querySelectorAll('.kanban-column');
      sections.forEach(sec => {
        if (sec.id === section + '-section') {
          sec.style.display = 'flex';
        } else {
          sec.style.display = 'none';
        }
      });
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        const span = item.querySelector('span');
        if (span && span.textContent.trim().toLowerCase() === section.toLowerCase()) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      if (itemId) {
        setTimeout(() => {
          const element = document.getElementById(itemId);
          if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.style.boxShadow = '0 0 10px 2px rgba(100, 100, 255, 0.5)';
            setTimeout(() => {
              element.style.boxShadow = 'none';
            }, 2000);
          }
        }, 500); // Delay to ensure the section is displayed
      }
    }

    // Removed Toggle Sidebar Function
    /*
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
      const main = document.querySelector('main');
      main.classList.toggle('full-width');
    }
    */

    // Reset Streaks for Tasks and Habits
    function resetStreaks() {
      const today = new Date().toDateString();
      tasks.forEach(task => {
        if (task.lastCompleted) {
          const last = new Date(task.lastCompleted);
          const diffDays = Math.floor((new Date() - last) / (1000 * 60 * 60 * 24));
          if (shouldResetStreak(task.recurrence, diffDays, last)) {
            task.streak = 0;
            task.lastCompleted = null;
          }
        }
      });

      habits.forEach(habit => {
        if (habit.lastCompleted) {
          const last = new Date(habit.lastCompleted);
          const diffDays = Math.floor((new Date() - last) / (1000 * 60 * 60 * 24));
          if (shouldResetStreak(habit.recurrence, diffDays, last)) {
            habit.streak = 0;
            habit.lastCompleted = null;
          }
        }
      });

      saveData();
      renderTasks();
      renderHabits();
      renderDashboardFavorites();
    }

    // Helper Function to Determine If Streak Should Reset
    function shouldResetStreak(recurrence, diffDays, lastDate) {
      const today = new Date();
      switch(recurrence) {
        case 'daily':
          return diffDays > 1;
        case 'weekly':
          return diffDays > 7;
        case 'monthly':
          return !isSameMonth(lastDate, today);
        case 'custom':
          // Assuming custom recurrence requires at least one day difference
          return diffDays > 1;
        default:
          return false;
      }
    }

    // Check if two dates are in the same month and year
    function isSameMonth(d1, d2) {
      return d1.getMonth() === d2.getMonth() && d1.getFullYear() === d2.getFullYear();
    }

    // Reset Streaks on Load
    resetStreaks();

    // Handle Search (Placeholder) - Now Implemented
    /*
    function showSearch() {
      alert('Search functionality is not implemented yet.');
    }
    */
    // Now replaced by openSearch and performSearch functions

    // Open the Search Modal
    function openSearch() {
      document.getElementById('search-modal').style.display = 'block';
      document.getElementById('search-input').focus();
    }

    // Close the Search Modal
    function closeSearch() {
      document.getElementById('search-modal').style.display = 'none';
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
    }

    // Perform Search
    function performSearch() {
      const query = document.getElementById('search-input').value.trim().toLowerCase();
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = ''; // Clear previous results

      if (query === '') {
        return; // If query is empty, do not display anything
      }

      // Function to highlight the matching text
      function highlight(text) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      // Search Notebooks
      const matchedNotebooks = notebooks.filter(nb => nb.name.toLowerCase().includes(query));
      if (matchedNotebooks.length > 0) {
        const category = document.createElement('div');
        category.className = 'search-category';
        category.innerHTML = '<h4>Notebooks</h4>';
        matchedNotebooks.forEach(nb => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(nb.name);
          item.onclick = () => {
            navigate('notebooks', `notebook-${nb.id}`);
            closeSearch();
          };
          category.appendChild(item);
        });
        resultsContainer.appendChild(category);
      }

      // Search Tags
      const matchedTags = tags.filter(tag => tag.name.toLowerCase().includes(query));
      if (matchedTags.length > 0) {
        const category = document.createElement('div');
        category.className = 'search-category';
        category.innerHTML = '<h4>Tags</h4>';
        matchedTags.forEach(tag => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(tag.name);
          item.onclick = () => {
            navigate('tags', `tag-${tag.name}`);
            closeSearch();
          };
          category.appendChild(item);
        });
        resultsContainer.appendChild(category);
      }

      // Search Notes
      const matchedNotes = notes.filter(note => {
        return (note.title && note.title.toLowerCase().includes(query)) ||
               (note.body && note.body.toLowerCase().includes(query));
      });
      if (matchedNotes.length > 0) {
        const category = document.createElement('div');
        category.className = 'search-category';
        category.innerHTML = '<h4>Notes</h4>';
        matchedNotes.forEach(note => {
          const item = document.createElement('div');
          item.className = 'search-item';
          const title = note.title ? highlight(note.title) : 'Untitled';
          item.innerHTML = `<strong>${title}</strong><br>${highlight(note.body || '')}`;
          item.onclick = () => {
            navigate('notes', `note-${note.id}`);
            closeSearch();
          };
          category.appendChild(item);
        });
        resultsContainer.appendChild(category);
      }

      // Search Tasks
      const matchedTasks = tasks.filter(task => task.description.toLowerCase().includes(query));
      if (matchedTasks.length > 0) {
        const category = document.createElement('div');
        category.className = 'search-category';
        category.innerHTML = '<h4>Tasks</h4>';
        matchedTasks.forEach(task => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(task.description);
          item.onclick = () => {
            navigate('tasks', `task-${task.id}`);
            closeSearch();
          };
          category.appendChild(item);
        });
        resultsContainer.appendChild(category);
      }

      // Search Habits
      const matchedHabits = habits.filter(habit => habit.description.toLowerCase().includes(query));
      if (matchedHabits.length > 0) {
        const category = document.createElement('div');
        category.className = 'search-category';
        category.innerHTML = '<h4>Habits</h4>';
        matchedHabits.forEach(habit => {
          const item = document.createElement('div');
          item.className = 'search-item';
          item.innerHTML = highlight(habit.description);
          item.onclick = () => {
            navigate('habits', `habit-${habit.id}`);
            closeSearch();
          };
          category.appendChild(item);
        });
        resultsContainer.appendChild(category);
      }

      // If no results found
      if (matchedNotebooks.length === 0 && matchedTags.length === 0 && matchedNotes.length === 0 && matchedTasks.length === 0 && matchedHabits.length === 0) {
        resultsContainer.innerHTML = '<p>No results found.</p>';
      }
    }

    // Close the modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('search-modal');
      if (event.target == modal) {
        modal.style.display = 'none';
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
      }
    };
  </script>
  
</body>
</html>
